<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Loading Schedule</title>
  <link rel="stylesheet" href="/static/css/cbrt-brand.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    .wrap {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 2rem;
      flex: 1;
    }

    .logo {
      max-height: 80px;
      max-width: 200px;
    }

    .welcome {
      border-left: 3px solid var(--primary, #2563eb);
      padding-left: 1.5rem;
      flex: 1;
    }

    .welcome h1 {
      margin: 0 0 0.5rem 0;
      color: #1e293b;
      font-size: 1.75rem;
    }

    .welcome p {
      margin: 0;
      color: #64748b;
      font-size: 1rem;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 2rem;
      padding-left: 2rem;
      border-left: 3px solid var(--primary, #2563eb);
    }

    .customer-logo {
      max-height: 80px;
      max-width: 200px;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    .summary { display:flex; gap: 1rem; align-items:center; margin-bottom: 1rem; }
    .summary .badge { background: #f3f4f6; border:1px solid #d1d5db; padding: .35rem .6rem; border-radius: 8px; }
    .filter-btn { padding: .35rem .8rem; border-radius: 6px; border: 1px solid #d1d5db; background: white; cursor: pointer; }
    .filter-btn.active { background: #2563eb; color: white; }
    .section { margin-bottom: 2rem; }
    .section-header {
      background: #f3f4f6;
      color: #1e293b;
      padding: .75rem 1rem;
      border-radius: 8px;
      margin-bottom: .5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }
    .section-header.overdue { background: #fee2e2; border-left: 4px solid #dc2626; }
    .section-header.today { background: #fef3c7; border-left: 4px solid #f59e0b; }
    .section-header.this-week { background: #dbeafe; border-left: 4px solid #2563eb; }
    .section-header.next-week { background: #f3f4f6; border-left: 4px solid #6b7280; }

    table { width:100%; }
    th, td { white-space: nowrap; text-align: left; padding: .5rem; }
    th { background: #f3f4f6; color: #1e293b; font-weight: 600; }

    tr.overdue { background: #fef2f2; }
    tr.today { background: #fffbeb; }
    tr.this-week { background: #eff6ff; }

    .urgency-badge {
      display: inline-block;
      padding: .2rem .5rem;
      border-radius: 4px;
      font-size: .75rem;
      font-weight: 600;
    }
    .urgency-badge.overdue { background: #dc2626; color: white; }
    .urgency-badge.today { background: #f59e0b; color: white; }
    .urgency-badge.this-week { background: #2563eb; color: white; }
    .urgency-badge.next-week { background: #6b7280; color: white; }
    .urgency-badge.later { background: #e5e7eb; color: #374151; }

    .progress-text { font-size: .85rem; color: #6b7280; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="header-left">
        <img src="/static/cbrt-logo-optimized.svg" alt="CBRT" class="logo" />
        <div class="welcome">
          <h1>Loading Schedule</h1>
          <p>Pending shipments by week</p>
        </div>
      </div>
      <div class="header-right">
        <img id="customerLogo" src="" alt="Customer Logo" class="customer-logo" style="display: none;" />
        <div class="header-actions">
          <span id="usernameDisplay" style="color: #64748b; font-weight: 500;">Loading...</span>
          <a href="/client.html" class="btn">Dashboard</a>
          <a href="/auth/logout/" class="btn btn-secondary">Logout</a>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="summary">
        <button id="refresh" class="btn btn-secondary btn-sm">Refresh</button>
        <span id="count" class="badge">0 pending loads</span>
        <div style="flex: 1;"></div>
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="overdue">Overdue Only</button>
        <button class="filter-btn" data-filter="this-week">This Week</button>
      </div>

      <div id="overdue-section" class="section" style="display:none;">
        <div class="section-header overdue">
          <span>‚ö†Ô∏è Overdue</span>
          <span class="progress-text" id="overdue-count"></span>
        </div>
        <table><thead><tr>
          <th>Release #</th><th>Load #</th><th>Date</th><th>Days</th><th>Customer</th><th>Tons</th><th>Carrier</th>
        </tr></thead><tbody id="overdue-tbody"></tbody></table>
      </div>

      <div id="today-section" class="section" style="display:none;">
        <div class="section-header today">
          <span>üìÖ Today</span>
          <span class="progress-text" id="today-count"></span>
        </div>
        <table><thead><tr>
          <th>Release #</th><th>Load #</th><th>Date</th><th>Days</th><th>Customer</th><th>Tons</th><th>Carrier</th>
        </tr></thead><tbody id="today-tbody"></tbody></table>
      </div>

      <div id="this-week-section" class="section" style="display:none;">
        <div class="section-header this-week">
          <span>üìÜ This Week</span>
          <span class="progress-text" id="this-week-count"></span>
        </div>
        <table><thead><tr>
          <th>Release #</th><th>Load #</th><th>Date</th><th>Days</th><th>Customer</th><th>Tons</th><th>Carrier</th>
        </tr></thead><tbody id="this-week-tbody"></tbody></table>
      </div>

      <div id="next-week-section" class="section" style="display:none;">
        <div class="section-header next-week">
          <span>üìã Next Week</span>
          <span class="progress-text" id="next-week-count"></span>
        </div>
        <table><thead><tr>
          <th>Release #</th><th>Load #</th><th>Date</th><th>Days</th><th>Customer</th><th>Tons</th><th>Carrier</th>
        </tr></thead><tbody id="next-week-tbody"></tbody></table>
      </div>

      <div id="later-section" class="section" style="display:none;">
        <div class="section-header">
          <span>üìÖ Later</span>
          <span class="progress-text" id="later-count"></span>
        </div>
        <table><thead><tr>
          <th>Release #</th><th>Load #</th><th>Date</th><th>Days</th><th>Customer</th><th>Tons</th><th>Carrier</th>
        </tr></thead><tbody id="later-tbody"></tbody></table>
      </div>
    </div>
  </div>

  <script>
    let allLoads = [];
    let currentFilter = 'all';

    async function getJSON(u){
      const r=await fetch(u, { credentials: 'same-origin' });
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function fmtDate(d) {
      if (!d) return '';
      try {
        if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
          const [y,m,dd] = d.split('-');
          return `${m}/${dd}/${y}`;
        }
      } catch(e) {}
      return String(d);
    }

    function formatDaysUntil(days) {
      if (days < 0) return `${Math.abs(days)}d overdue`;
      if (days === 0) return 'TODAY';
      if (days === 1) return 'Tomorrow';
      return `In ${days}d`;
    }

    function renderLoadRow(load) {
      const daysText = formatDaysUntil(load.daysUntil);
      // Client view: Link to client-friendly release detail page
      return `<tr class="${load.urgency}">
        <td><a href="/client-release.html?id=${load.releaseId}">${load.releaseNumber}</a></td>
        <td>${load.seq}</td>
        <td>${fmtDate(load.scheduledDate)}</td>
        <td><span class="urgency-badge ${load.urgency}">${daysText}</span></td>
        <td>${load.customer.name || ''}</td>
        <td>${load.plannedTons.toFixed(2)}</td>
        <td>${load.carrier.name || ''}</td>
      </tr>`;
    }

    function render() {
      const groups = {
        overdue: [],
        today: [],
        'this-week': [],
        'next-week': [],
        later: []
      };

      allLoads.forEach(load => {
        if (groups[load.urgency]) {
          groups[load.urgency].push(load);
        }
      });

      // Apply filter
      const visibleGroups = currentFilter === 'all' ?
        ['overdue', 'today', 'this-week', 'next-week', 'later'] :
        currentFilter === 'overdue' ? ['overdue'] :
        currentFilter === 'this-week' ? ['overdue', 'today', 'this-week'] :
        [];

      // Render each section
      Object.keys(groups).forEach(urgency => {
        const section = document.getElementById(`${urgency}-section`);
        const tbody = document.getElementById(`${urgency}-tbody`);
        const count = document.getElementById(`${urgency}-count`);

        const loads = groups[urgency];
        const visible = visibleGroups.includes(urgency);

        section.style.display = (visible && loads.length > 0) ? 'block' : 'none';
        if (count) count.textContent = `${loads.length} load${loads.length !== 1 ? 's' : ''}`;
        if (tbody) tbody.innerHTML = loads.map(renderLoadRow).join('');
      });

      const totalCount = allLoads.length;
      document.getElementById('count').textContent = `${totalCount} pending load${totalCount !== 1 ? 's' : ''}`;
    }

    async function load() {
      const res = await fetch('/api/releases/pending-loads/', { credentials: 'same-origin' });
      if (!res.ok) throw new Error(await res.text());
      allLoads = await res.json();
      render();
    }

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        render();
      });
    });

    // Load user info and branding on page load
    (async () => {
      // Load current user info
      try {
        const user = await getJSON("/api/auth/me/");
        if (user && user.username) {
          document.getElementById("usernameDisplay").textContent = `Welcome, ${user.username}`;
        }
      } catch (e) {
        console.log("Could not load user info:", e);
        document.getElementById("usernameDisplay").textContent = "Welcome";
      }

      // Load customer branding (logo and colors)
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const customerName = urlParams.get('customer_name');
        const customerId = urlParams.get('customer_id');

        let brandingUrl = '/api/customers/branding/';
        if (customerName) {
          brandingUrl += `?customer_name=${encodeURIComponent(customerName)}`;
        } else if (customerId) {
          brandingUrl += `?customer_id=${encodeURIComponent(customerId)}`;
        }

        const branding = await getJSON(brandingUrl);

        // Apply customer logo
        if (branding.logo_url) {
          const customerLogo = document.getElementById('customerLogo');
          customerLogo.src = branding.logo_url;
          customerLogo.style.display = 'block';
        }
        // Apply custom colors if provided
        if (branding.primary_color) {
          document.documentElement.style.setProperty('--primary', branding.primary_color);
        }
        if (branding.secondary_color) {
          document.documentElement.style.setProperty('--secondary', branding.secondary_color);
          document.body.style.background = `linear-gradient(135deg, ${branding.secondary_color} 0%, ${branding.primary_color} 100%)`;
        }
      } catch (e) {
        console.log('Could not load customer branding:', e);
        // Continue with default branding
      }

      // Load schedule data
      await load();
    })().catch(err => alert(err.message || String(err)));

    document.getElementById('refresh').addEventListener('click', () => load().catch(err=>alert(err.message||String(err))));
  </script>
</body>
</html>
