<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Create BOL</title>
  <link rel="stylesheet" href="/static/css/cbrt-brand.css">
  <style>
    .wrap { max-width: 820px; }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: var(--surface);
      border-radius: 12px;
      box-shadow: var(--shadow-md);
    }
    .nav-links {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .nav-links a {
      color: white !important;
      background: rgba(255, 255, 255, 0.1) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
    }
    .nav-links a:hover {
      background: rgba(255, 255, 255, 0.2) !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
    }
    .form-container {
      background: var(--surface);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
    }
    .truck-helper {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    /* Preview Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 {
      margin: 0;
      color: var(--primary);
    }
    .modal-body {
      flex: 1;
      overflow: auto;
      padding: 0;
    }
    .modal-body iframe {
      width: 100%;
      height: 600px;
      border: none;
    }
    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="page-header">
      <h2 style="margin:0;">Create BOL</h2>
      <div style="display: flex; align-items: center; gap: 15px;">
        <span id="usernameDisplay" style="color: #fff; font-weight: 500;">Loading...</span>
<a href="/auth/logout/" class="btn" style="background: #dc3545; color: white; padding: 8px 20px;">Logout</a>
      </div>
    </div>
    <div class="nav-links">
      <a href="/">Portal</a>
      <a href="/products.html">Products</a>
      <a href="/customers.html">Customers</a>
      <a href="/carriers.html">Carriers</a>
    </div>
    <div class="form-container">
      <form id="f">
        <div class="grid">
          <div class="form-group">
            <label>Release Load *</label>
            <select id="releaseLoad"></select>
          </div>
          <div class="form-group">
            <label>Date *
            <input type="date" name="date" required />
          </div>
          <div class="form-group">
            <label>Product *</label>
            <select name="productId" id="product" required></select>
          </div>
        </div>
        
        <div class="form-group">
          <label>Customer *</label>
          <select name="customerId" id="customer" onchange="updateCustomerAddress()" required disabled>
            <option value="">Select a customer...</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Customer PO #</label>
          <input name="customerPO" id="customerPO" placeholder="Optional" readonly />
        </div>
        
        <div class="form-group">
          <label>Ship-To Address *</label>
          <textarea name="shipTo" rows="3" id="shipToAddress" required readonly></textarea>
        </div>
        <input type="hidden" name="buyerName" id="buyerName" />
        
        <div class="form-group">
          <label>Carrier *</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <select name="carrierId" id="carrier" onchange="updateTruckOptions()" required style="flex: 1;">
              <option value="">Select a carrier...</option>
            </select>
            <button type="button" onclick="refreshCarriers()" class="btn btn-sm" title="Refresh carriers/trucks">
              &#x21BB;
            </button>
          </div>
        </div>

        <div class="grid">
          <div class="form-group">
            <label>Truck Number *</label>
            <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
              <div style="flex: 1;">
                <input name="truckNo" id="truckNo" placeholder="Enter or select below" list="truckList" required />
                <datalist id="truckList"></datalist>
                <div class="truck-helper">Type truck number or select from list</div>
              </div>
              <button type="button" onclick="showAddTruckModal()" class="btn btn-sm" title="Add new truck" style="white-space: nowrap;">
                + Add Truck
              </button>
            </div>
          </div>
          <div class="form-group">
            <label>Trailer Number</label>
            <input name="trailerNo" id="trailerNo" placeholder="Enter trailer number" />
          </div>
        </div>
        
        <div class="grid">
          <div class="form-group">
            <label>Net Tons *</label>
            <input type="number" step="0.01" name="netTons" placeholder="0.00" required />
          </div>
          <div class="form-group">
            <label>Notes</label>
            <input name="notes" placeholder="Optional notes" />
          </div>
        </div>
        
        <button type="submit" class="btn btn-accent">Preview BOL</button>
        <span id="status" class="status"></span>
      </form>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>BOL Preview</h3>
        <button onclick="closePreviewModal()" class="btn btn-secondary">×</button>
      </div>
      <div class="modal-body">
        <iframe id="pdfPreview"></iframe>
      </div>
      <div class="modal-footer">
        <button onclick="closePreviewModal()" class="btn btn-secondary">Edit</button>
        <button onclick="approveBOL()" class="btn btn-accent">Approve & Save</button>
      </div>
    </div>
  </div>

  <!-- Add Truck Modal -->
  <div id="addTruckModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Add New Truck</h3>
        <button onclick="closeAddTruckModal()" class="btn btn-secondary">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Truck Number *</label>
          <input type="text" id="newTruckNumber" placeholder="Enter truck number" required />
        </div>
        <div class="form-group">
          <label>Trailer Number</label>
          <input type="text" id="newTrailerNumber" placeholder="Enter trailer number (optional)" />
        </div>
        <div id="addTruckStatus" class="status"></div>
      </div>
      <div class="modal-footer">
        <button onclick="closeAddTruckModal()" class="btn btn-secondary">Cancel</button>
        <button onclick="saveNewTruck()" class="btn btn-accent">Add Truck</button>
      </div>
    </div>
  </div>

  <script src="/static/js/utils.js?v=2"></script>
  <script>
    function qs(id){return document.getElementById(id)}
    async function getJSON(u){
      const r=await fetch(u, {
        credentials: 'same-origin'
      });
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function postJSON(u, body){
      const r=await fetch(u,{
        method:"POST",
        headers:{
          'Content-Type':'application/json',
          'X-CSRFToken': Utils.getCSRFToken()
        },
        credentials: 'same-origin',
        body:JSON.stringify(body)
      });
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }

    let products = [];
    let customers = [];
    let carriers = [];
    let pendingBOLData = null;  // Store form data between preview and approval

    // Modal functions
    function showPreviewModal(pdfBase64) {
      const modal = qs("previewModal");
      const iframe = qs("pdfPreview");

      // Convert base64 to blob URL
      const blob = base64ToBlob(pdfBase64, 'application/pdf');
      const blobUrl = URL.createObjectURL(blob);

      // Load PDF in iframe
      iframe.src = blobUrl;

      // Show modal
      modal.classList.add('active');
    }

    function closePreviewModal() {
      const modal = qs("previewModal");
      const iframe = qs("pdfPreview");

      // Clear iframe
      iframe.src = '';

      // Hide modal
      modal.classList.remove('active');

      // Clear pending data
      pendingBOLData = null;
    }

    async function approveBOL() {
      if (!pendingBOLData) {
        alert('No BOL data to approve');
        return;
      }

      const s = qs("status");
      s.textContent = "Saving BOL...";

      try {
        const res = await postJSON("/api/bol/confirm/", pendingBOLData);
        if (res && res.ok) {
          closePreviewModal();

          s.innerHTML = `✅ Created <b>${res.bolNo}</b> — <a target="_blank" href="${res.pdfUrl}">Open PDF</a>`;

          // Open PDF in new tab automatically
          window.open(res.pdfUrl, '_blank');

          // Reset form
          qs("f").reset();
          qs("shipToAddress").value = "";
          qs("buyerName").value = "";

          // Set date to today again
          const d = new Date();
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth()+1).padStart(2,'0');
          const dd = String(d.getDate()).padStart(2,'0');
          document.querySelector('input[name=date]').value = `${yyyy}-${mm}-${dd}`;
        } else {
          s.textContent = "❌ " + (res.error || "Unknown error");
        }
      } catch (e) {
        console.error('BOL approval error:', e);
        s.textContent = "❌ " + (e.message || String(e));
      }
    }

    function base64ToBlob(base64, mimeType) {
      const byteCharacters = atob(base64);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      return new Blob([byteArray], { type: mimeType });
    }

    function updateCustomerAddress() {
      const customerId = qs("customer").value;
      const shipToField = qs("shipToAddress");
      const buyerField = qs("buyerName");
      
      if (!customerId) {
        shipToField.value = "";
        buyerField.value = "";
        return;
      }
      
      // Find customer - convert IDs to strings for comparison
      const customer = customers.find(c => String(c.id) === String(customerId));
      if (customer) {
        // Format the full address (Django uses snake_case)
        const address = customer.address + "\n" + 
                       customer.city + ", " + customer.state + " " + customer.zip;
        shipToField.value = address;
        buyerField.value = customer.customer;
      }
    }
    
    function updateTruckOptions() {
      const carrierId = qs("carrier").value;
      const truckNoField = qs("truckNo");
      const trailerNoField = qs("trailerNo");
      const truckDatalist = qs("truckList");
      
      // Clear existing options
      truckDatalist.innerHTML = "";
      truckNoField.value = "";
      trailerNoField.value = "";
      
      if (!carrierId) return;
      
      // Find carrier - convert IDs to strings for comparison
      const carrier = carriers.find(c => String(c.id) === String(carrierId));
      if (carrier && carrier.trucks) {
        // Filter active trucks (Django uses snake_case: is_active)
        const activeTrucks = carrier.trucks.filter(t => t.is_active !== false);
        
        // Add trucks to datalist for autocomplete
        activeTrucks.forEach(truck => {
          const option = document.createElement('option');
          option.value = truck.truck_number;
          option.textContent = `${truck.truck_number} / ${truck.trailer_number || 'N/A'}`;
          truckDatalist.appendChild(option);
        });
        
        // Auto-select first truck if only one available
        if (activeTrucks.length === 1) {
          truckNoField.value = activeTrucks[0].truck_number;
          trailerNoField.value = activeTrucks[0].trailer_number || '';
        }
      }
    }

    // Refresh carriers and trucks
    async function refreshCarriers() {
      const currentCarrierId = qs("carrier").value;
      try {
        carriers = await getJSON("/api/carriers/");

        // Rebuild carrier dropdown
        const carrierSelect = qs("carrier");
        const currentSelection = carrierSelect.value;
        carrierSelect.innerHTML = '<option value="">Select a carrier...</option>';
        carriers.forEach(c => {
          const opt = new Option(c.carrier_name, c.id);
          carrierSelect.add(opt);
        });

        // Restore selection
        if (currentSelection) {
          carrierSelect.value = currentSelection;
          updateTruckOptions();
        }

        showStatus('✓ Carriers/trucks refreshed', 'success');
        setTimeout(() => showStatus('', ''), 2000);
      } catch (e) {
        showStatus('Error refreshing carriers: ' + e.message, 'error');
      }
    }

    // Show add truck modal
    function showAddTruckModal() {
      const carrierId = qs("carrier").value;
      if (!carrierId) {
        showStatus('Please select a carrier first', 'error');
        setTimeout(() => showStatus('', ''), 2000);
        return;
      }
      qs("newTruckNumber").value = '';
      qs("newTrailerNumber").value = '';
      qs("addTruckStatus").textContent = '';
      qs("addTruckModal").classList.add('active');
    }

    // Close add truck modal
    function closeAddTruckModal() {
      qs("addTruckModal").classList.remove('active');
    }

    // Save new truck
    async function saveNewTruck() {
      const carrierId = qs("carrier").value;
      const truckNumber = qs("newTruckNumber").value.trim();
      const trailerNumber = qs("newTrailerNumber").value.trim();
      const statusEl = qs("addTruckStatus");

      if (!truckNumber) {
        statusEl.textContent = 'Truck number is required';
        return;
      }

      const carrier = carriers.find(c => String(c.id) === String(carrierId));
      if (!carrier) {
        statusEl.textContent = 'Carrier not found';
        return;
      }

      // Add truck to carrier
      if (!carrier.trucks) carrier.trucks = [];
      carrier.trucks.push({
        truck_number: truckNumber,
        trailer_number: trailerNumber,
        is_active: true
      });

      try {
        await postJSON('/api/carriers/', {
          id: carrier.id,
          carrier_name: carrier.carrier_name,
          contact_name: carrier.contact_name,
          phone: carrier.phone,
          email: carrier.email,
          is_active: carrier.is_active,
          trucks: carrier.trucks
        });

        // Close modal
        closeAddTruckModal();

        // Refresh truck list and select the newly added truck
        updateTruckOptions();
        qs("truckNo").value = truckNumber;
        qs("trailerNo").value = trailerNumber;

        showStatus('✓ Truck added successfully', 'success');
        setTimeout(() => showStatus('', ''), 2000);
      } catch (e) {
        statusEl.textContent = 'Error: ' + e.message;
      }
    }

    // Auto-fill trailer when truck number is entered from datalist
    qs("truckNo").addEventListener('input', function() {
      const carrierId = qs("carrier").value;
      const truckNo = this.value;
      const trailerNoField = qs("trailerNo");
      
      if (!carrierId || !truckNo) return;
      
      const carrier = carriers.find(c => String(c.id) === String(carrierId));
      if (carrier && carrier.trucks) {
        const truck = carrier.trucks.find(t => t.truck_number === truckNo);
        if (truck && truck.trailer_number) {
          trailerNoField.value = truck.trailer_number;
        }
      }
    });

    (async () => {
      // Load current user info
      try {
        const user = await getJSON("/api/auth/me/");
        if (user && user.username) {
          qs("usernameDisplay").textContent = `Welcome, ${user.username}`;
        }
      } catch (e) {
        qs("usernameDisplay").textContent = "Welcome";
      }

      // Load products, customers, and carriers in parallel
      const [productsData, customersData, carriersData] = await Promise.all([
        getJSON("/api/products/"),
        getJSON("/api/customers/"),
        getJSON("/api/carriers/")
      ]);
      
      products = productsData;
      customers = customersData;
      carriers = carriersData;

      // Load pending release loads for selection
      const loads = await getJSON('/api/releases/pending-loads/');
      const loadSel = qs('releaseLoad');
      if (loads.length === 0) {
        loadSel.add(new Option('No pending loads', ''));
        loadSel.disabled = true;
      } else {
        loadSel.add(new Option('Select release load…',''));
        loads.forEach(ld => loadSel.add(new Option(`${ld.label} — ${ld.customer.name||''} — ${ld.scheduledDate||''} — ${Number(ld.plannedTons||0).toFixed(3)} NT`, ld.loadId)));
      }

      // Populate products dropdown (lock later on load select)
      const productSel = qs("product");
      products
        .filter(p => p.is_active !== false)
        .forEach(p => productSel.add(new Option(p.name, p.id)));

      // Populate customers dropdown
      const customerSel = qs("customer");
      customers
        .filter(c => c.is_active !== false)
        .forEach(c => customerSel.add(new Option(c.customer, c.id)));
      
      // Populate carriers dropdown (Django uses snake_case: carrier_name, is_active)
      const carrierSel = qs("carrier");
      carriers
        .filter(c => c.is_active !== false)
        .forEach(c => carrierSel.add(new Option(c.carrier_name, c.id)));

      // Check for productId in URL
      const params = new URLSearchParams(location.search);
      const pid = params.get("productId");
      if (pid) productSel.value = pid;

      // Check for loadId in URL (from release detail "Create BOL" button)
      const loadIdParam = params.get("loadId");
      if (loadIdParam) {
        try {
          const loadData = await getJSON(`/api/releases/load/${loadIdParam}/`);
          const load = loadData.load;
          const release = loadData.release;

          // Auto-select the load in dropdown
          loadSel.value = load.id;

          // Pre-fill customer
          if (release.customer_ref_id) {
            qs('customer').value = release.customer_ref_id;
          }

          // Pre-fill ship-to address
          const shipToLines = [
            release.ship_to_name,
            release.ship_to_street,
            `${release.ship_to_city || ''}, ${release.ship_to_state || ''} ${release.ship_to_zip || ''}`
          ].filter(Boolean);
          qs('shipToAddress').value = shipToLines.join('\n');

          // Pre-fill customer PO
          if (release.customer_po) {
            qs('customerPO').value = release.customer_po;
          }

          // Pre-fill product if available
          if (release.lot_ref && release.lot_ref.product) {
            productSel.value = release.lot_ref.product;
            productSel.disabled = true;
          }

          // Pre-fill carrier if available
          if (release.carrier_ref_id) {
            carrierSel.value = release.carrier_ref_id;
          }

          // Pre-fill buyer name from customer
          if (release.customer_id_text) {
            const buyerField = qs('buyerName');
            if (buyerField) buyerField.value = release.customer_id_text;
          }

          // Show notice
          const s = qs("status");
          s.textContent = `Creating BOL for Release #${release.release_number}, Load #${load.seq}`;
          s.className = 'status';
        } catch (e) {
          console.error('Failed to load release/load data:', e);
          const s = qs("status");
          s.textContent = `Error loading load data: ${e.message}`;
          s.className = 'status error';
        }
      }

      // Set today's date
      const d = new Date(); 
      const yyyy = d.getFullYear(); 
      const mm = String(d.getMonth()+1).padStart(2,'0'); 
      const dd = String(d.getDate()).padStart(2,'0');
      document.querySelector('input[name=date]').value = `${yyyy}-${mm}-${dd}`;

      // On release load select, auto-fill locked fields
      loadSel.addEventListener('change', () => {
        const id = loadSel.value;
        const chosen = (window._loadsCache || []).find(x => String(x.loadId) === String(id));
        if (!chosen) {
          qs('customer').value = '';
          qs('shipToAddress').value='';
          qs('customerPO').value='';
          productSel.disabled=false;
          return;
        }
        // Cache product/customer
        if (chosen.product?.id) { productSel.value = chosen.product.id; productSel.disabled = true; }
        if (chosen.customer?.id) { qs('customer').value = chosen.customer.id; }
        // Ship-to and buyer
        const st = chosen.shipTo||{}; const lines = [st.name, st.street, st.street2, `${st.city||''}, ${st.state||''} ${st.zip||''}`].filter(Boolean);
        qs('shipToAddress').value = lines.join('\n');
        qs('customerPO').value = chosen.customerPO || '';
        const buyer = (chosen.customer && chosen.customer.name) || '';
        const buyerField = qs('buyerName'); if (buyerField) buyerField.value = buyer;
        // Default carrier to planned one (editable)
        const carrierSel = qs('carrier'); if (carrierSel && chosen.carrier && chosen.carrier.id) carrierSel.value = chosen.carrier.id;
        // Suggest planned tons (editable)
        const nt = document.querySelector('input[name=netTons]'); if (nt && chosen.plannedTons) nt.value = Number(chosen.plannedTons||0).toFixed(2);
      });
      window._loadsCache = await getJSON('/api/releases/pending-loads/');

      // Form submission - preview first
      qs("f").addEventListener("submit", async (ev) => {
        ev.preventDefault();
        const s = qs("status");
        s.textContent = "Generating preview...";

        const data = Object.fromEntries(new FormData(ev.target).entries());
        // Ensure locked fields are present even if controls are disabled/readonly
        if (!data.productId) { const ps = qs('product'); if (ps && ps.value) data.productId = ps.value; }
        if (!data.buyerName) { const bf = qs('buyerName'); if (bf && bf.value) data.buyerName = bf.value; }
        if (!data.shipTo) { const sa = qs('shipToAddress'); if (sa && sa.value) data.shipTo = sa.value; }
        if (!data.date) { const de = document.querySelector('input[name=date]'); if (de && de.value) data.date = de.value; }
        if (!data.customerPO) { const po = qs('customerPO'); if (po && po.value) data.customerPO = po.value; }
        const prod = products.find(p => String(p.id) === String(data.productId));
        data.productName = prod ? prod.name : "";
        const loadSel2 = qs('releaseLoad'); if (loadSel2 && loadSel2.value) data.loadId = loadSel2.value;

        // Store data for later approval
        pendingBOLData = data;

        try {
          const res = await postJSON("/api/bol/preview/", data);
          if (res && res.ok && res.pdfBase64) {
            s.textContent = "";
            showPreviewModal(res.pdfBase64);
          } else {
            s.textContent = "❌ " + (res.error || "Preview failed");
            pendingBOLData = null;
          }
        } catch (e) {
          console.error('BOL preview error:', e);
          s.textContent = "❌ " + (e.message || String(e));
          pendingBOLData = null;
        }
      });
    })().catch(e => {
      console.error('Initialization error:', e);
      alert('Error loading data: ' + e.message);
    });
  </script>
</body>
</html>