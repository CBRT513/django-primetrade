{% extends 'kiosk/base.html' %}

{% block title %}Complete{% endblock %}

{% block content %}
<div class="success-message">
    <h1 style="color: #059669;">All Done!</h1>

    <p style="font-size: 20px;">BOL {{ session.bol_number }} has been signed.</p>

    {% if pdf_error %}
    <div class="error" style="margin: 20px 0;">{{ pdf_error }}</div>
    <p style="font-size: 18px;">Your code: <strong>{{ session.code }}</strong></p>
    {% else %}
    <button type="button" class="btn btn-primary" id="printBtn">
        PRINT BOL
    </button>
    <p id="printStatus" style="margin-top: 10px; font-size: 14px; color: #6b7280; display: none;"></p>
    {% endif %}

    <p style="margin-top: 40px; font-size: 24px; color: #374151;">
        Safe travels!
    </p>

    <a href="{% url 'kiosk:home' %}" class="btn btn-secondary" style="margin-top: 40px;">
        DONE
    </a>
</div>

<!-- Hidden iframe for printing -->
<iframe id="printFrame" style="display: none;"></iframe>

<script>
document.getElementById('printBtn').addEventListener('click', function() {
    const btn = this;
    const status = document.getElementById('printStatus');
    const frame = document.getElementById('printFrame');

    btn.disabled = true;
    btn.textContent = 'LOADING...';
    status.style.display = 'block';
    status.textContent = 'Preparing document...';

    // Load PDF in iframe
    frame.src = '{{ pdf_url }}';

    frame.onload = function() {
        status.textContent = 'Opening print dialog...';

        // Small delay to ensure PDF is fully rendered
        setTimeout(function() {
            try {
                frame.contentWindow.print();
            } catch(e) {
                // If iframe print fails (cross-origin), open in new tab
                window.open('{{ pdf_url }}', '_blank');
            }

            btn.disabled = false;
            btn.textContent = 'PRINT BOL';
            status.style.display = 'none';
        }, 500);
    };

    // Fallback if iframe doesn't load in 5 seconds
    setTimeout(function() {
        if (btn.disabled) {
            window.open('{{ pdf_url }}', '_blank');
            btn.disabled = false;
            btn.textContent = 'PRINT BOL';
            status.style.display = 'none';
        }
    }, 5000);
});
</script>
{% endblock %}
