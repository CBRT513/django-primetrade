<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Release Upload</title>
  <link rel="stylesheet" href="/static/css/cbrt-brand.css">
</head>
<body>
  <div class="wrap">
    <div class="cbrt-header" style="position: relative;">
      <div class="company-info">
        <img src="/static/cbrt-logo-optimized.svg" alt="CBRT" class="company-logo">
        <div>
          <h1 class="company-name">Release Upload</h1>
          <p class="company-tagline">Parse customer PDF to create a release</p>
        </div>
      </div>
      <div class="user-actions" style="position: absolute; top: 20px; right: 20px; display:flex; gap:.5rem;">
        <a href="/" class="btn">Home</a>
        <a href="/api/releases/open/view/" class="btn">Open Releases</a>
        <a href="/auth/logout/" class="btn" style="background: #dc3545; color: white; padding: 8px 20px;">Logout</a>
      </div>
    </div>

    <div class="card" style="padding: 1.5rem;">
      <div id="status" class="status" style="min-height: 1.25rem; margin-bottom: 0.5rem; color: var(--text-secondary);"></div>
      <form id="uploadForm">
        <input type="file" id="file" accept="application/pdf" required />
        <label style="margin-left:0.75rem; font-size: 0.9rem;">
          <input type="checkbox" id="useAI" checked style="margin-right:0.35rem;"> Use AI parser
        </label>
        <select id="aiMode" style="margin-left:0.5rem; padding: 6px 8px;">
          <option value="cloud" selected>cloud (OpenRouter/Groq)</option>
          <option value="local">local (Ollama)</option>
        </select>
        <button class="btn btn-accent" type="submit">Upload & Parse</button>
      </form>
      <pre id="out" style="margin-top:1rem; white-space: pre-wrap; background:#111; color:#eee; padding:1rem; border-radius:8px; max-height: 400px; overflow: auto;"></pre>
    </div>
  </div>

  <!-- Review Modal -->
  <div id="reviewModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 1000;">
    <div style="background: var(--surface, #fff); border-radius: 12px; width: min(980px, 95vw); max-height: 90vh; overflow: auto; box-shadow: var(--shadow-xl, 0 12px 24px rgba(0,0,0,.2)); border: 1px solid var(--border, #e5e7eb);">
      <div style="display:flex;justify-content:space-between;align-items:center;padding: 1rem 1.25rem; border-bottom: 1px solid var(--border, #e5e7eb);">
        <h3 style="margin: 0;">Review Parsed Release</h3>
        <button id="closeReview" class="btn btn-danger btn-sm" type="button">Close</button>
      </div>
      <div style="padding: 1rem 1.25rem;">
        <div id="modalStatus" class="status" style="margin-bottom:.5rem;"></div>
        <form id="reviewForm" onsubmit="return false;">
          <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
            <div class="form-group">
              <label>Release #</label>
              <input id="releaseNumber" type="text" readonly>
            </div>
            <div class="form-group">
              <label>Release Date</label>
              <input id="releaseDate" type="date">
            </div>
            <div class="form-group">
              <label>Customer ID</label>
              <input id="customerId" type="text">
            </div>
            <div class="form-group">
              <label>Customer PO</label>
              <input id="customerPO" type="text">
            </div>
            <div class="form-group">
              <label>Carrier</label>
              <input id="carrier" type="text">
            </div>
            <div class="form-group">
              <label>Quantity (Net Tons)</label>
              <input id="qtyTons" type="number" step="0.001">
            </div>
          </div>

          <div class="form-group">
            <label>Ship To</label>
            <div style="display:grid; grid-template-columns: 1fr 2fr; gap: 0.75rem; margin-bottom: 0.5rem;">
              <input id="shipToName" placeholder="Name" type="text">
              <input id="shipToStreet" placeholder="Street" type="text">
            </div>
            <div style="margin-bottom: 0.5rem;">
              <input id="shipToStreet2" placeholder="Address Line 2 (optional)" type="text">
            </div>
            <div style="display:grid; grid-template-columns: 1.5fr 0.5fr 0.5fr; gap: 0.75rem;">
              <input id="shipToCity" placeholder="City" type="text">
              <input id="shipToState" placeholder="State" maxlength="2" type="text">
              <input id="shipToZip" placeholder="Zip (5)" inputmode="numeric" pattern="\d{5}" type="text">
            </div>
          </div>

          <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));">
            <div class="form-group">
              <label>Lot</label>
              <input id="materialLot" type="text">
            </div>
            <div class="form-group">
              <label>Material Description</label>
              <input id="materialDescription" type="text">
            </div>
          </div>

          <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
            <div class="form-group">
              <label>C</label>
              <input id="chemC" type="number" step="0.001">
            </div>
            <div class="form-group">
              <label>Si</label>
              <input id="chemSi" type="number" step="0.001">
            </div>
            <div class="form-group">
              <label>S</label>
              <input id="chemS" type="number" step="0.001">
            </div>
            <div class="form-group">
              <label>P</label>
              <input id="chemP" type="number" step="0.001">
            </div>
            <div class="form-group">
              <label>Mn</label>
              <input id="chemMn" type="number" step="0.001">
            </div>
          </div>

          <div class="form-group">
            <label>Schedule</label>
            <div id="scheduleList" class="table-container" style="background:transparent; border:none;">
              <!-- rows injected -->
            </div>
          </div>

          <div class="form-group">
            <label>BOL Requirements</label>
            <textarea id="bolReqs" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label>Special Instructions (Warehouse Requirements)</label>
            <textarea id="specialInstructions" rows="4" placeholder="Warehouse requirements, delivery instructions, etc."></textarea>
          </div>

          <div style="display:flex; gap: 0.5rem; justify-content:flex-end; margin-top: 0.75rem;">
            <button id="copyJson" class="btn btn-secondary btn-sm" type="button">Copy JSON</button>
            <button id="approveSave" class="btn btn-accent btn-sm" type="button">Approve & Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="/static/js/utils.js?v=2"></script>
  <script>
const out = document.getElementById('out');
const form = document.getElementById('uploadForm');
const modal = document.getElementById('reviewModal');
const closeBtn = document.getElementById('closeReview');
const copyBtn = document.getElementById('copyJson');

function toISODate(d) {
  if (!d) return '';
  try {
    // Handle already-ISO
    if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
    const dt = new Date(d);
    if (!isNaN(dt)) return dt.toISOString().slice(0,10);
  } catch (_) {}
  return '';
}

function parseAddress(raw) {
  let s = (raw || '').trim();
  // Strip any glued customer token after ZIP
  s = s.replace(/(\b\d{5}\b)\s*[A-Z].*$/i, '$1');
  const parts = s.split(',').map(t => t.trim()).filter(Boolean);
  let street='', city='', state='', zip='';
  if (parts.length >= 3) {
    [street, city] = [parts[0], parts[1]];
    const rest = parts.slice(2).join(', ');
    const m = rest.match(/([A-Z]{2})\s*(\d{5})/i);
    if (m) { state = m[1].toUpperCase(); zip = m[2]; }
    else {
      const m2 = rest.match(/\b([A-Z]{2})\b/); if (m2) state = m2[1].toUpperCase();
      const m3 = rest.match(/(\d{5})/); if (m3) zip = m3[1];
    }
  } else if (parts.length === 2) {
    street = parts[0];
    const m = parts[1].match(/^(.+?)\s+([A-Z]{2})\s*(\d{5})/i);
    if (m) { city = m[1].trim(); state = m[2].toUpperCase(); zip = m[3]; }
    else { city = parts[1]; }
  } else {
    street = s;
  }
  zip = (zip || '').replace(/\D/g, '').slice(0,5);
  if (zip.length !== 5) zip = '';
  return {street, city, state, zip};
}

function toUSDate(d) {
  if (!d) return '';
  if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
    const [y,m,dd] = d.split('-');
    return `${m}/${dd}/${y}`;
  }
  try {
    const dt = new Date(d);
    if (!isNaN(dt)) return `${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getDate()).padStart(2,'0')}/${dt.getFullYear()}`;
  } catch (_) {}
  return String(d);
}

function fillReview(parsed) {
  const p = parsed || {};
  const ship = (p.shipToRaw || {});
  document.getElementById('releaseNumber').value = p.releaseNumber || '';
  document.getElementById('releaseDate').value = toISODate(p.releaseDate) || '';
  document.getElementById('customerId').value = p.customerId || '';
  document.getElementById('customerPO').value = p.customerPO || '';
  document.getElementById('carrier').value = p.carrier || p.shipVia || '';
  document.getElementById('qtyTons').value = p.quantityNetTons ?? '';

  // Use backend parser's already-parsed components from shipToRaw
  // Backend now returns: street, street2, city, state, zip
  document.getElementById('shipToName').value = ship.name || '';
  document.getElementById('shipToStreet').value = ship.street || '';
  document.getElementById('shipToStreet2').value = ship.street2 || '';
  document.getElementById('shipToCity').value = ship.city || '';
  document.getElementById('shipToState').value = ship.state || '';
  document.getElementById('shipToZip').value = ship.zip || '';
  document.getElementById('materialLot').value = (p.material && p.material.lot) || '';
  document.getElementById('materialDescription').value = (p.material && p.material.description) || '';
  const an = (p.material && p.material.analysis) || {};
  document.getElementById('chemC').value = an.C ?? '';
  document.getElementById('chemSi').value = an.Si ?? '';
  document.getElementById('chemS').value = an.S ?? '';
  document.getElementById('chemP').value = an.P ?? '';
  document.getElementById('chemMn').value = an.Mn ?? '';

  const schedEl = document.getElementById('scheduleList');
  const sched = Array.isArray(p.schedule) ? p.schedule : [];
  if (sched.length === 0) {
    schedEl.innerHTML = '<div style="color: var(--text-secondary); padding: 0.5rem 0;">No schedule found</div>';
  } else {
    const perLoad = (Number(p.quantityNetTons) && sched.length) ? Number(p.quantityNetTons)/sched.length : null;
    let html = '<table><thead><tr><th>Date</th><th>Load #</th><th>Net Tons</th></tr></thead><tbody>';
    for (const row of sched) {
      const d = toUSDate(row.date || row);
      const l = (row.load ?? '').toString();
      const nt = perLoad != null && isFinite(perLoad) ? perLoad.toFixed(3) : '';
      html += `<tr><td>${d}</td><td>${l}</td><td>${nt}${nt? ' NT':''}</td></tr>`;
    }
    html += '</tbody></table>';
    schedEl.innerHTML = html;
  }

  const bolReqsArr = Array.isArray(p.bolRequirements) ? p.bolRequirements : [];
  const bolReqs = bolReqsArr.length ? ('- ' + bolReqsArr.join('\n- ')) : '';
  document.getElementById('bolReqs').value = bolReqs;

  document.getElementById('specialInstructions').value = p.specialInstructions || '';
}

function openReview(parsed) {
  try { window._lastParsed = parsed; } catch (_) {}
  fillReview(parsed && parsed.parsed ? parsed.parsed : parsed);
  modal.style.display = 'flex';
}
function closeReview() { modal.style.display = 'none'; }
closeBtn.addEventListener('click', closeReview);
modal.addEventListener('click', (e) => { if (e.target === modal) closeReview(); });
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeReview(); });
copyBtn.addEventListener('click', () => {
  const data = window._lastParsed && (window._lastParsed.parsed || window._lastParsed) || {};
  try {
    const plus = { shipTo: {
      name: document.getElementById('shipToName')?.value || '',
      street: document.getElementById('shipToStreet')?.value || '',
      street2: document.getElementById('shipToStreet2')?.value || '',
      city: document.getElementById('shipToCity')?.value || '',
      state: document.getElementById('shipToState')?.value || '',
      zip: document.getElementById('shipToZip')?.value || ''
    }};
    data._review = plus;
  } catch (_) {}
  const txt = JSON.stringify(data, null, 2);
  navigator.clipboard.writeText(txt).then(() => {
    if (window.Utils && Utils.showStatus) Utils.showStatus('Copied JSON to clipboard', 'success');
  }).catch(() => {
    if (window.Utils && Utils.showStatus) Utils.showStatus('Copy failed', 'error');
  });
});

// Approve & Save Release
const approveBtn = document.getElementById('approveSave');
approveBtn.addEventListener('click', async () => {
  const p = window._lastParsed && (window._lastParsed.parsed || window._lastParsed) || {};
  const ship = {
    name: document.getElementById('shipToName')?.value || '',
    street: document.getElementById('shipToStreet')?.value || '',
    street2: document.getElementById('shipToStreet2')?.value || '',
    city: document.getElementById('shipToCity')?.value || '',
    state: document.getElementById('shipToState')?.value || '',
    zip: (document.getElementById('shipToZip')?.value || '').replace(/\D/g,'').slice(0,5),
  };
  const toNum = (v) => {
    const s = (v ?? '').toString().trim();
    if (s === '') return undefined;
    const n = Number(s);
    return Number.isFinite(n) ? n : undefined;
  };
  const payload = {
    releaseNumber: document.getElementById('releaseNumber')?.value || p.releaseNumber,
    releaseDate: document.getElementById('releaseDate')?.value || p.releaseDate,
    customerId: document.getElementById('customerId')?.value || p.customerId,
    customerPO: document.getElementById('customerPO')?.value || p.customerPO,
    // Use Carrier field as shipVia
    shipVia: document.getElementById('carrier')?.value || p.carrier || p.shipVia,
    shipTo: ship,
    material: {
      lot: document.getElementById('materialLot')?.value || (p.material?.lot || ''),
      description: document.getElementById('materialDescription')?.value || (p.material?.description || ''),
      analysis: {
        C: toNum(document.getElementById('chemC')?.value),
        Si: toNum(document.getElementById('chemSi')?.value),
        S: toNum(document.getElementById('chemS')?.value),
        P: toNum(document.getElementById('chemP')?.value),
        Mn: toNum(document.getElementById('chemMn')?.value),
      }
    },
    quantityNetTons: toNum(document.getElementById('qtyTons')?.value) ?? (Number(p.quantityNetTons||'') || undefined),
    schedule: Array.isArray(p.schedule) ? p.schedule : [],
    specialInstructions: document.getElementById('specialInstructions')?.value || '',
  };
  try {
    const csrf = (window.Utils && Utils.getCSRFToken) ? Utils.getCSRFToken() : null;
    const resp = await fetch('/api/releases/approve/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...(csrf ? {'X-CSRFToken': csrf} : {}) },
      credentials: 'same-origin',
      body: JSON.stringify(payload)
    });
    const json = await resp.json().catch(()=>null);
    if (!resp.ok) {
      const ms = document.getElementById('modalStatus');
      // Duplicate release UX
      if (resp.status === 409 && (json?.error || '').toLowerCase().includes('duplicate')) {
        const link = json?.id ? ` — <a href="/api/releases/${json.id}/view/" style="text-decoration:underline; color: #721c24;">View existing</a>` : '';
        ms.innerHTML = `Release ${payload.releaseNumber} already exists${link}.`;
        ms.className = 'status error';
        const rn = document.getElementById('releaseNumber');
        rn.style.borderColor = 'var(--error)';
        rn.style.boxShadow = '0 0 0 3px rgba(184, 68, 42, 0.15)';
        rn.focus();
      } else {
        ms.textContent = (json?.error || json?.detail || `HTTP ${resp.status}`);
        ms.className = 'status error';
      }
      if (window.Utils && Utils.showStatus) Utils.showStatus(ms.textContent || 'Save failed', 'error', 8000);
      return;
    }
    if (window.Utils && Utils.showStatus) Utils.showStatus(`Release saved (ID ${json.id})`, 'success');
    // Close modal and navigate to Open Releases for confirmation
    try { modal.style.display = 'none'; } catch(_){}
    setTimeout(() => { window.location.href = '/api/releases/open/view/'; }, 600);
  } catch (e) {
    const ms = document.getElementById('modalStatus');
    ms.textContent = e?.message || String(e) || 'Save failed';
    ms.className = 'status error';
    if (window.Utils && Utils.showStatus) Utils.showStatus(`Save failed: ${e.message || e}`, 'error', 8000);
  }
});

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const fileInput = document.getElementById('file');
  const file = fileInput.files[0];
  const zipEl = document.getElementById('shipToZip');
  if (zipEl) { zipEl.value = (zipEl.value || '').replace(/\D/g, '').slice(0,5); }
  if (!file) {
    if (window.Utils && Utils.showStatus) Utils.showStatus('Please choose a PDF to upload.', 'error');
    return;
  }
  const submitBtn = e.submitter || form.querySelector('button[type="submit"]');
  if (submitBtn) submitBtn.disabled = true;
  out.textContent = 'Uploading and parsing…';
  try {
    const fd = new FormData();
    fd.append('file', file);
    const headers = {};
    try {
      const csrf = (window.Utils && Utils.getCSRFToken) ? Utils.getCSRFToken() : null;
      if (csrf) headers['X-CSRFToken'] = csrf;
    } catch (_) {}
    const aiChecked = document.getElementById('useAI')?.checked;
    const aiMode = document.getElementById('aiMode')?.value || 'cloud';
    const url = aiChecked ? `/api/releases/upload/?ai=${encodeURIComponent(aiMode)}` : '/api/releases/upload/';
    const resp = await fetch(url, {
      method: 'POST',
      credentials: 'same-origin',
      headers,
      body: fd
    });
    if (resp.status === 401) {
      if (window.Utils && Utils.showStatus) Utils.showStatus('Session expired. Redirecting to login…', 'error');
      window.location.href = '/login/?next=' + encodeURIComponent(window.location.pathname);
      return;
    }
    if (resp.status === 403) {
      if (window.Utils && Utils.showStatus) Utils.showStatus('Action blocked (CSRF). Refresh this page and try again.', 'error', 8000);
      return;
    }
    const contentType = resp.headers.get('content-type') || '';
    const txt = await resp.text();
    let parsed = null;
    if (contentType.includes('application/json')) {
      try { parsed = JSON.parse(txt); } catch (_) {}
    }
    out.textContent = parsed ? JSON.stringify(parsed, null, 2) : txt;
    if (!resp.ok) {
      const msg = (parsed && (parsed.error || parsed.detail)) ? `${parsed.error || parsed.detail}` : `HTTP ${resp.status}`;
      if (window.Utils && Utils.showStatus) Utils.showStatus(`Parse failed: ${msg}`, 'error', 8000);
    } else {
      if (window.Utils && Utils.showStatus) Utils.showStatus('Parse complete' + (parsed && parsed.ai ? ` (AI: ${parsed.ai})` : '' ) + '.', 'success');
      if (parsed && parsed.ok && parsed.parsed) { openReview(parsed); }
      // Focus Approve button to make next action obvious
      try { document.getElementById('approveSave')?.focus(); } catch(_) {}
    }
    try { out.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } catch (_) {}
  } catch (err) {
    console.error(err);
    if (window.Utils && Utils.showStatus) Utils.showStatus('Upload failed.', 'error');
    out.textContent = String(err);
  } finally {
    if (submitBtn) submitBtn.disabled = false;
  }
});
  </script>
</body>
</html>
