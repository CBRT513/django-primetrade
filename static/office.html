<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Create BOL</title>
  <link rel="stylesheet" href="/static/css/cbrt-brand.css">
  <style>
    .wrap { max-width: 820px; }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: var(--surface);
      border-radius: 12px;
      box-shadow: var(--shadow-md);
    }
    .nav-links {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .nav-links a {
      color: white !important;
      background: rgba(255, 255, 255, 0.1) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
    }
    .nav-links a:hover {
      background: rgba(255, 255, 255, 0.2) !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
    }
    .form-container {
      background: var(--surface);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
    }
    .truck-helper {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="page-header">
      <h2 style="margin:0;">Create BOL</h2>
    </div>
    <div class="nav-links">
      <a href="/">Portal</a>
      <a href="/products.html">Products</a>
      <a href="/customers.html">Customers</a>
      <a href="/carriers.html">Carriers</a>
    </div>
    <div class="form-container">
      <form id="f">
        <div class="grid">
          <div class="form-group">
            <label>Date *</label>
            <input type="date" name="date" required />
          </div>
          <div class="form-group">
            <label>Product *</label>
            <select name="productId" id="product" required></select>
          </div>
        </div>
        
        <div class="form-group">
          <label>Customer *</label>
          <select name="customerId" id="customer" onchange="updateCustomerAddress()" required>
            <option value="">Select a customer...</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Customer PO #</label>
          <input name="customerPO" placeholder="Optional" />
        </div>
        
        <div class="form-group">
          <label>Ship-To Address *</label>
          <textarea name="shipTo" rows="3" id="shipToAddress" required></textarea>
        </div>
        <input type="hidden" name="buyerName" id="buyerName" />
        
        <div class="form-group">
          <label>Carrier *</label>
          <select name="carrierId" id="carrier" onchange="updateTruckOptions()" required>
            <option value="">Select a carrier...</option>
          </select>
        </div>
        
        <div class="grid">
          <div class="form-group">
            <label>Truck Number *</label>
            <input name="truckNo" id="truckNo" placeholder="Enter or select below" list="truckList" required />
            <datalist id="truckList"></datalist>
            <div class="truck-helper">Type truck number or select from list</div>
          </div>
          <div class="form-group">
            <label>Trailer Number</label>
            <input name="trailerNo" id="trailerNo" placeholder="Enter trailer number" />
          </div>
        </div>
        
        <div class="grid">
          <div class="form-group">
            <label>Net Tons *</label>
            <input type="number" step="0.01" name="netTons" placeholder="0.00" required />
          </div>
          <div class="form-group">
            <label>Notes</label>
            <input name="notes" placeholder="Optional notes" />
          </div>
        </div>
        
        <button type="submit" class="btn btn-accent">Create BOL</button>
        <span id="status" class="status"></span>
      </form>
    </div>
  </div>

  <script src="/static/js/utils.js?v=2"></script>
  <script>
    function qs(id){return document.getElementById(id)}
    async function getJSON(u){
      const r=await fetch(u, {
        credentials: 'same-origin'
      });
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function postJSON(u, body){
      const r=await fetch(u,{
        method:"POST",
        headers:{
          'Content-Type':'application/json',
          'X-CSRFToken': Utils.getCSRFToken()
        },
        credentials: 'same-origin',
        body:JSON.stringify(body)
      });
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }

    let products = [];
    let customers = [];
    let carriers = [];
    
    function updateCustomerAddress() {
      const customerId = qs("customer").value;
      const shipToField = qs("shipToAddress");
      const buyerField = qs("buyerName");
      
      if (!customerId) {
        shipToField.value = "";
        buyerField.value = "";
        return;
      }
      
      // Find customer - convert IDs to strings for comparison
      const customer = customers.find(c => String(c.id) === String(customerId));
      if (customer) {
        // Format the full address (Django uses snake_case)
        const address = customer.address + "\n" + 
                       customer.city + ", " + customer.state + " " + customer.zip;
        shipToField.value = address;
        buyerField.value = customer.customer;
      }
    }
    
    function updateTruckOptions() {
      const carrierId = qs("carrier").value;
      const truckNoField = qs("truckNo");
      const trailerNoField = qs("trailerNo");
      const truckDatalist = qs("truckList");
      
      // Clear existing options
      truckDatalist.innerHTML = "";
      truckNoField.value = "";
      trailerNoField.value = "";
      
      if (!carrierId) return;
      
      // Find carrier - convert IDs to strings for comparison
      const carrier = carriers.find(c => String(c.id) === String(carrierId));
      if (carrier && carrier.trucks) {
        // Filter active trucks (Django uses snake_case: is_active)
        const activeTrucks = carrier.trucks.filter(t => t.is_active !== false);
        
        // Add trucks to datalist for autocomplete
        activeTrucks.forEach(truck => {
          const option = document.createElement('option');
          option.value = truck.truck_number;
          option.textContent = `${truck.truck_number} / ${truck.trailer_number || 'N/A'}`;
          truckDatalist.appendChild(option);
        });
        
        // Auto-select first truck if only one available
        if (activeTrucks.length === 1) {
          truckNoField.value = activeTrucks[0].truck_number;
          trailerNoField.value = activeTrucks[0].trailer_number || '';
        }
      }
    }
    
    // Auto-fill trailer when truck number is entered from datalist
    qs("truckNo").addEventListener('input', function() {
      const carrierId = qs("carrier").value;
      const truckNo = this.value;
      const trailerNoField = qs("trailerNo");
      
      if (!carrierId || !truckNo) return;
      
      const carrier = carriers.find(c => String(c.id) === String(carrierId));
      if (carrier && carrier.trucks) {
        const truck = carrier.trucks.find(t => t.truck_number === truckNo);
        if (truck && truck.trailer_number) {
          trailerNoField.value = truck.trailer_number;
        }
      }
    });

    (async () => {
      // Load products, customers, and carriers in parallel
      const [productsData, customersData, carriersData] = await Promise.all([
        getJSON("/api/products/"),
        getJSON("/api/customers/"),
        getJSON("/api/carriers/")
      ]);
      
      products = productsData;
      customers = customersData;
      carriers = carriersData;
      
      // Populate products dropdown (Django uses snake_case: is_active)
      const productSel = qs("product");
      products
        .filter(p => p.is_active !== false)
        .forEach(p => productSel.add(new Option(p.name, p.id)));

      // Populate customers dropdown
      const customerSel = qs("customer");
      customers
        .filter(c => c.is_active !== false)
        .forEach(c => customerSel.add(new Option(c.customer, c.id)));
      
      // Populate carriers dropdown (Django uses snake_case: carrier_name, is_active)
      const carrierSel = qs("carrier");
      carriers
        .filter(c => c.is_active !== false)
        .forEach(c => carrierSel.add(new Option(c.carrier_name, c.id)));

      // Check for productId in URL
      const params = new URLSearchParams(location.search);
      const pid = params.get("productId");
      if (pid) productSel.value = pid;

      // Set today's date
      const d = new Date(); 
      const yyyy = d.getFullYear(); 
      const mm = String(d.getMonth()+1).padStart(2,'0'); 
      const dd = String(d.getDate()).padStart(2,'0');
      document.querySelector('input[name=date]').value = `${yyyy}-${mm}-${dd}`;

      // Form submission
      qs("f").addEventListener("submit", async (ev) => {
        ev.preventDefault();
        const s = qs("status");
        s.textContent = "Creating BOL...";
        
        const data = Object.fromEntries(new FormData(ev.target).entries());
        const prod = products.find(p => String(p.id) === String(data.productId));
        data.productName = prod ? prod.name : "";
        
        try {
          const res = await postJSON("/api/bol/", data);
          if (res && res.ok) {
            s.innerHTML = `✅ Created <b>${res.bolNo}</b> — <a target="_blank" href="${res.pdfUrl}">Open PDF</a> | <a target="_blank" href="/bol.html?id=${res.bolId}">View BOL</a>`;
            
            // Open BOL in new tab automatically
            window.open(`/bol.html?id=${res.bolId}`, '_blank');
            
            // Reset form
            ev.target.reset();
            qs("shipToAddress").value = "";
            qs("buyerName").value = "";
            
            // Set date to today again
            document.querySelector('input[name=date]').value = `${yyyy}-${mm}-${dd}`;
          } else {
            s.textContent = "❌ " + (res.error || "Unknown error");
          }
        } catch (e) {
          console.error('BOL creation error:', e);
          s.textContent = "❌ " + (e.message || String(e));
        }
      });
    })().catch(e => {
      console.error('Initialization error:', e);
      alert('Error loading data: ' + e.message);
    });
  </script>
</body>
</html>