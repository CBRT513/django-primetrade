<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weight Variance Report - {{ product.name }}</title>
    <style>
        :root {
            --brand-primary: #005500;
            --brand-dark: #004400;
            --brand-light: #e8f5e9;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --text-muted: #999;
            --bg-white: #fff;
            --bg-light: #f9fafb;
            --border-color: #e5e5e5;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --danger: #dc2626;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .header {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
        }

        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo { height: 40px; width: auto; }

        .company-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .company-tagline {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-logout {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            text-decoration: none;
        }

        .btn-logout:hover { background: #c82333; }

        .nav {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 0;
            padding: 0 2rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }

        .nav-link:hover {
            color: var(--brand-primary);
            background: var(--bg-light);
        }

        .nav-link svg { width: 18px; height: 18px; }

        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .page-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .controls select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.875rem;
            background: var(--bg-white);
        }

        .card {
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 1rem;
            background: var(--bg-light);
            border-radius: 8px 8px 0 0;
        }

        .card-body { padding: 1.5rem; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            border: none;
        }

        .btn-primary {
            background: var(--brand-primary);
            color: white;
        }

        .btn-primary:hover { background: var(--brand-dark); }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover { background: var(--border-color); }

        /* Summary grid */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .stat-card {
            text-align: center;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 6px;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-light);
        }

        tbody td {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border-color);
        }

        tbody tr:hover { background: var(--bg-light); }

        .text-right { text-align: right; }
        .font-mono { font-family: 'Courier New', monospace; }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-danger {
            background: #fef2f2;
            color: #dc2626;
        }

        .badge-warning {
            background: #fffbeb;
            color: #d97706;
        }

        .badge-success {
            background: #f0fdf4;
            color: #16a34a;
        }

        .badge-muted {
            background: #f3f4f6;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .inventory-table td:first-child { font-weight: 500; }

        a { color: #2563eb; }
        a:hover { text-decoration: underline; }

        .footer {
            max-width: 1200px;
            margin: 2rem auto 0;
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        .footer p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
            .page-header { flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body>
    <script src="/static/js/staging-banner.js"></script>
    <header class="header">
        <div class="header-inner">
            <div class="logo-section">
                <img src="/static/cbrt-logo-optimized.svg" alt="CBRT" class="logo">
                <div>
                    <div class="company-name">Cincinnati Barge & Rail Terminal</div>
                    <div class="company-tagline">Weight Variance Report</div>
                </div>
            </div>
            <div class="user-section">
                <a href="/" class="btn btn-secondary">Dashboard</a>
                <a href="/products.html" class="btn btn-secondary">Products</a>
                <a href="/auth/logout/" class="btn-logout">Logout</a>
            </div>
        </div>
    </header>

    <nav class="nav">
        <div class="nav-inner">
            <a href="/" class="nav-link">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                Dashboard
            </a>
            <a href="/products.html" class="nav-link">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                Products
            </a>
            <a href="/api/inventory-report/" class="nav-link">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Inventory
            </a>
        </div>
    </nav>

    <main class="main">
        <div class="page-header">
            <div>
                <h1 class="page-title">Weight Variance Report</h1>
                <p class="page-subtitle">{{ product.name }} — Bucket vs. Official Weight Analysis</p>
            </div>
            <div class="controls">
                <form method="get" action="/api/variance-report/" style="display: flex; gap: 0.5rem; align-items: center;">
                    <select name="product_id" onchange="this.form.submit()">
                        {% for p in products %}
                        <option value="{{ p.id }}" {% if p.id == product.id %}selected{% endif %}>{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </form>
                <a href="/api/variance-report/pdf/?product_id={{ product.id }}" class="btn btn-primary">Download PDF</a>
            </div>
        </div>

        <!-- Section 1: Executive Summary -->
        <div class="card">
            <div class="card-header">Executive Summary</div>
            <div class="card-body">
                {% if summary.total_bols == 0 %}
                <div class="empty-state">No BOLs found for this product.</div>
                {% else %}
                <div class="summary-grid">
                    <div class="stat-card">
                        <div class="stat-value">{{ summary.total_bols }}</div>
                        <div class="stat-label">Total BOLs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ summary.with_official }}</div>
                        <div class="stat-label">With Official Weight</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ summary.without_official }}</div>
                        <div class="stat-label">Missing Official</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ summary.coverage_pct }}%</div>
                        <div class="stat-label">Coverage</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        {% if summary.total_bols > 0 %}

        <!-- Section 2: Bucket Weight Accuracy -->
        <div class="card">
            <div class="card-header">Bucket Weight Accuracy</div>
            <div class="card-body">
                {% if not accuracy.has_data %}
                <div class="empty-state">No paired data available (need BOLs with both bucket and official weights).</div>
                {% else %}
                <table>
                    <thead>
                        <tr>
                            <th>Dataset</th>
                            <th class="text-right">Count</th>
                            <th class="text-right">Mean Variance %</th>
                            <th class="text-right">Median %</th>
                            <th class="text-right">Std Dev %</th>
                            <th class="text-right">Heavier</th>
                            <th class="text-right">Lighter</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>All Paired Records</td>
                            <td class="text-right font-mono">{{ accuracy.all.count }}</td>
                            <td class="text-right font-mono">{{ accuracy.all.mean }}%</td>
                            <td class="text-right font-mono">{{ accuracy.all.median }}%</td>
                            <td class="text-right font-mono">{% if accuracy.all.stdev is not None %}{{ accuracy.all.stdev }}%{% else %}—{% endif %}</td>
                            <td class="text-right font-mono">{{ accuracy.all_count_heavier }}</td>
                            <td class="text-right font-mono">{{ accuracy.all_count_lighter }}</td>
                        </tr>
                        {% if accuracy.has_clean %}
                        <tr>
                            <td>Clean (&le;5% variance)</td>
                            <td class="text-right font-mono">{{ accuracy.clean.count }}</td>
                            <td class="text-right font-mono">{{ accuracy.clean.mean }}%</td>
                            <td class="text-right font-mono">{{ accuracy.clean.median }}%</td>
                            <td class="text-right font-mono">{% if accuracy.clean.stdev is not None %}{{ accuracy.clean.stdev }}%{% else %}—{% endif %}</td>
                            <td class="text-right font-mono">{{ accuracy.clean_count_heavier }}</td>
                            <td class="text-right font-mono">{{ accuracy.clean_count_lighter }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="empty-state">Insufficient clean data (need &ge;2 records within 5% variance)</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
                <p style="margin-top: 0.75rem; font-size: 0.8125rem; color: var(--text-muted);">
                    Positive variance = official heavier than bucket. Negative = official lighter than bucket.
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Section 3: Inventory Comparison -->
        <div class="card">
            <div class="card-header">Inventory Comparison (3 Scenarios)</div>
            <div class="card-body">
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Scenario</th>
                            <th class="text-right">Shipped</th>
                            <th class="text-right">Remaining</th>
                            <th>Method</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Bucket Only</td>
                            <td class="text-right font-mono">{{ inventory.bucket_shipped }}</td>
                            <td class="text-right font-mono">{{ inventory.bucket_remaining }}</td>
                            <td><span class="badge badge-muted">sum(net_tons) — canonical</span></td>
                        </tr>
                        <tr>
                            <td>Hybrid</td>
                            <td class="text-right font-mono">{{ inventory.hybrid_shipped }}</td>
                            <td class="text-right font-mono">{{ inventory.hybrid_remaining }}</td>
                            <td><span class="badge badge-muted">official where available, else bucket</span></td>
                        </tr>
                        <tr>
                            <td>Best Estimate</td>
                            <td class="text-right font-mono">{{ inventory.best_shipped }}</td>
                            <td class="text-right font-mono">{{ inventory.best_remaining }}</td>
                            <td><span class="badge badge-muted">hybrid + {{ inventory.correction_factor }}% correction</span></td>
                        </tr>
                    </tbody>
                </table>
                <p style="margin-top: 0.75rem; font-size: 0.8125rem; color: var(--text-muted);">
                    Starting inventory: {{ inventory.start_tons }} tons. Correction factor derived from clean paired data mean variance.
                </p>
            </div>
        </div>

        <!-- Section 4: Carrier Variance -->
        <div class="card">
            <div class="card-header">Carrier Variance</div>
            <div class="card-body">
                {% if carriers %}
                <table>
                    <thead>
                        <tr>
                            <th>Carrier</th>
                            <th class="text-right">BOLs</th>
                            <th class="text-right">Avg Variance %</th>
                            <th class="text-right">Min %</th>
                            <th class="text-right">Max %</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in carriers %}
                        <tr>
                            <td>{{ c.carrier_name }}</td>
                            <td class="text-right font-mono">{{ c.bol_count }}</td>
                            <td class="text-right font-mono">{{ c.avg_variance_pct }}%</td>
                            <td class="text-right font-mono">{{ c.min_variance_pct }}%</td>
                            <td class="text-right font-mono">{{ c.max_variance_pct }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">No paired data available for carrier analysis.</div>
                {% endif %}
            </div>
        </div>

        <!-- Section 5: Buyer Summary -->
        <div class="card">
            <div class="card-header">Buyer Summary</div>
            <div class="card-body">
                {% if buyers %}
                <table>
                    <thead>
                        <tr>
                            <th>Buyer</th>
                            <th class="text-right">BOLs</th>
                            <th class="text-right">Total Net Tons</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for b in buyers %}
                        <tr>
                            <td>{{ b.buyer_name }}</td>
                            <td class="text-right font-mono">{{ b.bol_count }}</td>
                            <td class="text-right font-mono">{{ b.total_net_tons }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">No BOL data available.</div>
                {% endif %}
            </div>
        </div>

        <!-- Section 6: Flagged Outliers -->
        <div class="card">
            <div class="card-header">Flagged Outliers (&gt;5% Variance)</div>
            <div class="card-body">
                {% if outliers %}
                <table>
                    <thead>
                        <tr>
                            <th>BOL #</th>
                            <th>Date</th>
                            <th class="text-right">Bucket (tons)</th>
                            <th class="text-right">Official (tons)</th>
                            <th class="text-right">Variance %</th>
                            <th>Inferred Cause</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for o in outliers %}
                        <tr>
                            <td><a href="/bols/{{ o.id }}/">{{ o.bol_number }}</a></td>
                            <td>{{ o.date }}</td>
                            <td class="text-right font-mono">{{ o.net_tons }}</td>
                            <td class="text-right font-mono">{{ o.official_tons }}</td>
                            <td class="text-right font-mono">
                                {% if o.variance_pct > 10 or o.variance_pct < -10 %}
                                <span class="badge badge-danger">{{ o.variance_pct }}%</span>
                                {% else %}
                                <span class="badge badge-warning">{{ o.variance_pct }}%</span>
                                {% endif %}
                            </td>
                            <td>{{ o.cause }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">No outliers detected. All paired records are within 5% variance.</div>
                {% endif %}
            </div>
        </div>

        <!-- Section 7: Missing Official Weights -->
        <div class="card">
            <div class="card-header">Missing Official Weights ({{ missing|length }})</div>
            <div class="card-body">
                {% if missing %}
                <table>
                    <thead>
                        <tr>
                            <th>BOL #</th>
                            <th>Date</th>
                            <th>Buyer</th>
                            <th>Carrier</th>
                            <th class="text-right">Bucket (tons)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in missing %}
                        <tr>
                            <td><a href="/bols/{{ m.id }}/">{{ m.bol_number }}</a></td>
                            <td>{{ m.date }}</td>
                            <td>{{ m.buyer_name }}</td>
                            <td>{{ m.carrier_name }}</td>
                            <td class="text-right font-mono">{{ m.net_tons }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">All BOLs have official weights recorded.</div>
                {% endif %}
            </div>
        </div>

        {% endif %}
    </main>

    <footer class="footer">
        <p>&copy; 2024 Cincinnati Barge & Rail Terminal. All rights reserved.</p>
    </footer>
</body>
</html>
