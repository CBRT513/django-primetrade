<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Releases</title>
  <link rel="stylesheet" href="/static/css/cbrt-brand.css">
  <style>
    .summary { display:flex; gap: 1rem; align-items:center; flex-wrap: wrap; }
    .summary .badge { background: var(--surface-elevated); border:1px solid var(--border); padding: .35rem .6rem; border-radius: 8px; }
    table { width:100%; }
    th, td { white-space: nowrap; }
    .progress-bar {
      width: 100px;
      height: 20px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      display: inline-block;
      vertical-align: middle;
      margin-right: .5rem;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      transition: width 0.3s;
    }
    .urgency-badge {
      display: inline-block;
      padding: .2rem .5rem;
      border-radius: 4px;
      font-size: .75rem;
      font-weight: 600;
      margin-left: .5rem;
    }
    .urgency-badge.overdue { background: #dc2626; color: white; }
    .urgency-badge.due-soon { background: #f59e0b; color: white; }
    .urgency-badge.upcoming { background: #10b981; color: white; }

    /* Status filter tabs */
    .status-tabs {
      display: flex;
      gap: 0.5rem;
      margin-left: auto;
    }
    .status-tab {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.2s;
    }
    .status-tab:hover {
      background: var(--surface-elevated);
    }
    .status-tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Status badge in table */
    .status-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-badge.open { background: #dbeafe; color: #1e40af; }
    .status-badge.complete { background: #dcfce7; color: #166534; }
    .status-badge.cancelled { background: #fee2e2; color: #991b1b; }

    /* Data table controls */
    .table-controls {
      display: flex;
      gap: 1rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .search-box {
      flex: 1;
      min-width: 200px;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      background: var(--surface);
    }
    .search-box:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
    }
    .page-size-select {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.875rem;
      background: var(--surface);
    }
    th.sortable {
      cursor: pointer;
      user-select: none;
    }
    th.sortable:hover {
      background: rgba(0,0,0,0.05);
    }
    th.sortable::after {
      content: ' â†•';
      opacity: 0.5;
    }
    th.sortable.asc::after {
      content: ' â†‘';
      opacity: 1;
    }
    th.sortable.desc::after {
      content: ' â†“';
      opacity: 1;
    }
    .pagination {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      align-items: center;
      margin-top: 1rem;
    }
    .pagination button {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-primary);
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .pagination button:hover:not(:disabled) {
      background: var(--surface-elevated);
    }
    .pagination .page-info {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="cbrt-header" style="position: relative;">
      <div class="company-info">
        <img src="/static/cbrt-logo-optimized.svg" alt="CBRT" class="company-logo">
        <div>
          <h1 class="company-name">Releases</h1>
          <p class="company-tagline">View and manage releases</p>
        </div>
      </div>
      <div class="user-actions" style="position: absolute; top: 20px; right: 20px; display:flex; gap:.5rem;">
        <a href="/" class="btn">Home</a>
        <a href="/loading-schedule.html" class="btn">Loading Schedule</a>
        <a href="/releases.html" class="btn">Upload Release</a>
        <a href="/auth/logout/" class="btn" style="background: #dc3545; color: white; padding: 8px 20px;">Logout</a>
      </div>
    </div>

    <div class="card">
      <div class="summary">
        <button id="refresh" class="btn btn-secondary btn-sm">Refresh</button>
        <span id="count" class="badge">0 releases</span>
        <div class="status-tabs">
          <button class="status-tab active" data-status="OPEN">Open</button>
          <button class="status-tab" data-status="COMPLETE">Complete</button>
          <button class="status-tab" data-status="CANCELLED">Cancelled</button>
          <button class="status-tab" data-status="ALL">All</button>
        </div>
      </div>
      <div style="margin-top: 0.75rem; padding: 0.75rem; background: #f0f9ff; border-left: 4px solid #059669; border-radius: 4px; font-size: 0.9rem;">
        <strong>Weight Display:</strong>
        <span style="color: #059669; font-weight: 600;">ðŸŸ¢ Green</span> = Official (certified scale),
        <span style="color: #f59e0b; font-weight: 600;">ðŸŸ  Amber</span> = Planned (estimate).
        Mix shows: <span style="color: #059669;">Official</span>/<span style="color: #f59e0b;">Planned</span>/Total
      </div>
      <div class="table-controls">
        <input type="text" id="releaseSearch" class="search-box" placeholder="Search release#, customer...">
        <select id="releasePageSize" class="page-size-select">
          <option value="10">10 per page</option>
          <option value="25">25 per page</option>
          <option value="50">50 per page</option>
          <option value="100">100 per page</option>
        </select>
      </div>
      <div class="table-container" style="margin-top:.75rem;">
        <table id="tbl">
          <thead>
            <tr>
              <th class="sortable" data-sort="releaseNumber">Release #</th>
              <th class="sortable" data-sort="customer">Customer</th>
              <th class="sortable" data-sort="status">Status</th>
              <th class="sortable" data-sort="loadsShipped">Loads</th>
              <th class="sortable" data-sort="tonsShipped">Tons<br/><span style="font-size: 0.85em; font-weight: 400; color: #6b7280;">(Shipped / Total)</span></th>
              <th class="sortable" data-sort="nextScheduledDate">Next Load</th>
              <th class="sortable" data-sort="lastShippedDate">Last Shipped</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="pagination" id="releasePagination"></div>
      </div>
    </div>
  </div>

  <script>
    function fmtDate(d) {
      if (!d) return '';
      try {
        if (/^\d{4}-\d{2}-\d{2}$/.test(d)) { const [y,m,dd] = d.split('-'); return `${m}/${dd}/${y}`; }
        const dt = new Date(d); if (!isNaN(dt)) return `${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getDate()).padStart(2,'0')}/${dt.getFullYear()}`;
      } catch(e) {}
      return String(d);
    }

    // Table state
    let allReleases = [];
    let filteredReleases = [];
    let currentPage = 1;
    let pageSize = 10;
    let sortColumn = 'releaseNumber';
    let sortDirection = 'asc';
    let currentStatus = 'OPEN';

    async function load(status) {
      currentStatus = status || currentStatus;
      const res = await fetch(`/api/releases/?status=${currentStatus}`, { credentials: 'same-origin' });
      if (!res.ok) throw new Error(await res.text());
      allReleases = await res.json();
      // Add computed tonsShipped for sorting
      allReleases.forEach(r => {
        r.tonsShipped = Number(r.tonsOfficial || 0) + Number(r.tonsPlanned || 0);
      });
      updateCount();
      applyFilters();
    }

    function updateCount() {
      const statusLabel = currentStatus === 'ALL' ? '' : currentStatus.toLowerCase();
      document.getElementById('count').textContent = `${allReleases.length} ${statusLabel} release${allReleases.length !== 1 ? 's' : ''}`;
    }

    function applyFilters() {
      const searchQuery = (document.getElementById('releaseSearch').value || '').toLowerCase();

      filteredReleases = allReleases.filter(r => {
        if (searchQuery) {
          return (r.releaseNumber || '').toLowerCase().includes(searchQuery) ||
                 (r.customer || '').toLowerCase().includes(searchQuery);
        }
        return true;
      });

      currentPage = 1;
      renderReleases();
    }

    function renderReleases() {
      const tbody = document.querySelector('#tbl tbody');

      if (filteredReleases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No releases found</td></tr>';
        document.getElementById('releasePagination').innerHTML = '';
        return;
      }

      // Sort
      const sorted = [...filteredReleases].sort((a, b) => {
        let aVal = a[sortColumn] || '';
        let bVal = b[sortColumn] || '';
        if (['loadsShipped', 'totalLoads', 'tonsShipped', 'totalTons'].includes(sortColumn)) {
          aVal = Number(aVal) || 0;
          bVal = Number(bVal) || 0;
        }
        if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });

      // Paginate
      const totalPages = Math.ceil(sorted.length / pageSize);
      currentPage = Math.min(currentPage, totalPages);
      const start = (currentPage - 1) * pageSize;
      const pageData = sorted.slice(start, start + pageSize);

      tbody.innerHTML = pageData.map(r => {
        // Progress bar for loads
        const progress = r.totalLoads > 0 ? (r.loadsShipped / r.totalLoads * 100) : 0;
        const loadsDisplay = `
          <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
          ${r.loadsShipped} / ${r.totalLoads}
        `;

        // Build tons display with color coding
        const official = Number(r.tonsOfficial || 0);
        const planned = Number(r.tonsPlanned || 0);
        const total = Number(r.totalTons || 0);

        let tonsDisplay = '';
        if (official > 0 && planned > 0) {
          tonsDisplay = `<span style="color: #059669; font-weight: 600;">${official.toFixed(3)}</span>/<span style="color: #f59e0b; font-weight: 600;">${planned.toFixed(3)}</span>/<span style="font-weight: 600;">${total.toFixed(3)}</span>`;
        } else if (official > 0) {
          tonsDisplay = `<span style="color: #059669; font-weight: 700;">${official.toFixed(3)}</span> / ${total.toFixed(3)}`;
        } else if (planned > 0) {
          tonsDisplay = `<span style="color: #f59e0b; font-weight: 700;">${planned.toFixed(3)}</span> / ${total.toFixed(3)}`;
        } else {
          tonsDisplay = `0.000 / ${total.toFixed(3)}`;
        }

        // Urgency badge for next load (only for open releases)
        let urgencyBadge = '';
        if (r.status === 'OPEN') {
          if (r.isOverdue) {
            const daysOverdue = Math.abs(r.daysUntilNextLoad);
            urgencyBadge = `<span class="urgency-badge overdue">${daysOverdue}d overdue</span>`;
          } else if (r.daysUntilNextLoad !== null && r.daysUntilNextLoad <= 2) {
            urgencyBadge = `<span class="urgency-badge due-soon">${r.daysUntilNextLoad === 0 ? 'Today' : r.daysUntilNextLoad === 1 ? 'Tomorrow' : 'Soon'}</span>`;
          } else if (r.daysUntilNextLoad !== null) {
            urgencyBadge = `<span class="urgency-badge upcoming">In ${r.daysUntilNextLoad}d</span>`;
          }
        }

        // Status badge
        const statusClass = (r.status || 'open').toLowerCase();
        const statusBadge = `<span class="status-badge ${statusClass}">${r.status || 'OPEN'}</span>`;

        return `<tr>
          <td><a href="/api/releases/${r.id}/view/">${r.releaseNumber}</a></td>
          <td>${r.customer||''}</td>
          <td>${statusBadge}</td>
          <td>${loadsDisplay}</td>
          <td>${tonsDisplay}</td>
          <td>${fmtDate(r.nextScheduledDate)}${urgencyBadge}</td>
          <td>${fmtDate(r.lastShippedDate)}</td>
        </tr>`;
      }).join('');

      // Pagination
      const paginationEl = document.getElementById('releasePagination');
      if (totalPages > 1) {
        paginationEl.innerHTML = `
          <button onclick="releasePage(1)" ${currentPage === 1 ? 'disabled' : ''}>First</button>
          <button onclick="releasePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Prev</button>
          <span class="page-info">Page ${currentPage} of ${totalPages} (${filteredReleases.length} total)</span>
          <button onclick="releasePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
          <button onclick="releasePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Last</button>
        `;
      } else {
        paginationEl.innerHTML = `<span class="page-info">${filteredReleases.length} total</span>`;
      }
    }

    window.releasePage = function(page) {
      currentPage = page;
      renderReleases();
    };

    // Status tabs
    document.querySelectorAll('.status-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        load(this.dataset.status).catch(err => alert(err.message || String(err)));
      });
    });

    // Search
    document.getElementById('releaseSearch').addEventListener('input', applyFilters);

    // Page size
    document.getElementById('releasePageSize').addEventListener('change', function() {
      pageSize = parseInt(this.value);
      currentPage = 1;
      renderReleases();
    });

    // Sortable columns
    document.querySelectorAll('#tbl th.sortable').forEach(th => {
      th.addEventListener('click', function() {
        const col = this.dataset.sort;
        if (sortColumn === col) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = col;
          sortDirection = 'asc';
        }
        document.querySelectorAll('#tbl th.sortable').forEach(t => t.classList.remove('asc', 'desc'));
        this.classList.add(sortDirection);
        renderReleases();
      });
    });

    document.getElementById('refresh').addEventListener('click', () => load().catch(err=>alert(err.message||String(err))));
    load().catch(err=>alert(err.message||String(err)));
  </script>
</body>
</html>
