{% extends 'kiosk/base.html' %}

{% block title %}{% if lang == 'es' %}Completo{% else %}Complete{% endif %}{% endblock %}

{% block content %}
<div class="success-message">
    <h1 style="color: #059669;">{% if lang == 'es' %}Â¡Listo!{% else %}All Done!{% endif %}</h1>

    <p style="font-size: 20px;">{% if lang == 'es' %}BOL {{ session.bol_number }} ha sido firmado.{% else %}BOL {{ session.bol_number }} has been signed.{% endif %}</p>

    {% if pdf_error %}
    <div class="error" style="margin: 20px 0;">{{ pdf_error }}</div>
    <p style="font-size: 18px;">{% if lang == 'es' %}Su cÃ³digo:{% else %}Your code:{% endif %} <strong>{{ session.code }}</strong></p>
    {% else %}
    <button type="button" class="btn btn-primary" id="printBtn" style="font-size: 24px; padding: 20px 40px;">
        {% if lang == 'es' %}IMPRIMIR BOL{% else %}PRINT BOL{% endif %}
    </button>
    {% endif %}

    <p style="margin-top: 40px; font-size: 24px; color: #374151;">
        {% if lang == 'es' %}Â¡Buen viaje!{% else %}Safe travels!{% endif %}
    </p>

    <a href="{% url 'kiosk:home' %}" class="btn btn-secondary" style="margin-top: 40px;">
        {% if lang == 'es' %}LISTO{% else %}DONE{% endif %}
    </a>
</div>

<!-- Print instruction overlay -->
<div id="printOverlay" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    text-align: center;
    padding: 40px;
">
    <div style="background: #fef3c7; border: 4px solid #f59e0b; border-radius: 20px; padding: 40px; max-width: 500px;">
        <p style="font-size: 72px; margin: 0 0 20px 0;">ðŸ‘†</p>
        <h2 style="font-size: 42px; color: #92400e; margin: 0 0 20px 0;">{% if lang == 'es' %}TOQUE "PRINT"{% else %}TAP "PRINT"{% endif %}</h2>
        <p style="font-size: 24px; color: #78350f; margin: 0;">
            {% if lang == 'es' %}
            En el cuadro que apareciÃ³,<br>
            toque el botÃ³n azul <strong>Print</strong>
            {% else %}
            In the box that just appeared,<br>
            tap the blue <strong>Print</strong> button
            {% endif %}
        </p>
    </div>
    <button type="button" onclick="closePrintOverlay()" style="
        margin-top: 30px;
        background: #6b7280;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 8px;
        cursor: pointer;
    ">{% if lang == 'es' %}Cancelar{% else %}Cancel{% endif %}</button>
</div>

<!-- Hidden iframe for printing -->
<iframe id="printFrame" style="position: absolute; left: -9999px; width: 1px; height: 1px;"></iframe>

<script>
const printBtn = document.getElementById('printBtn');
const printOverlay = document.getElementById('printOverlay');
const printFrame = document.getElementById('printFrame');

function closePrintOverlay() {
    printOverlay.style.display = 'none';
}

if (printBtn) {
    printBtn.addEventListener('click', function() {
        // Show the instruction overlay
        printOverlay.style.display = 'flex';

        // Load PDF in iframe and trigger print
        printFrame.src = '{{ pdf_url }}';

        printFrame.onload = function() {
            setTimeout(function() {
                try {
                    printFrame.contentWindow.print();
                } catch(e) {
                    // Fallback: open in new tab
                    window.open('{{ pdf_url }}', '_blank');
                    closePrintOverlay();
                }
            }, 300);
        };

        // Auto-hide overlay after 15 seconds (print dialog dismissed)
        setTimeout(closePrintOverlay, 15000);
    });
}

// Hide overlay if user taps outside the instruction box
printOverlay.addEventListener('click', function(e) {
    if (e.target === printOverlay) {
        closePrintOverlay();
    }
});
</script>
{% endblock %}
