<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Release Detail</title>
  <link rel="stylesheet" href="/static/css/cbrt-brand.css">
  <style>
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 0.75rem; }
    .card { padding: 1.25rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="cbrt-header" style="position: relative;">
      <div class="company-info">
        <img src="/static/cbrt-logo-optimized.svg" alt="CBRT" class="company-logo">
        <div>
          <h1 class="company-name">Release</h1>
          <p class="company-tagline">View/Edit Release</p>
        </div>
      </div>
      <div class="user-actions" style="position: absolute; top: 20px; right: 20px; display:flex; gap:.5rem;">
        <a href="/" class="btn">Home</a>
        <a href="/api/releases/open/view/" class="btn">Open Releases</a>
        <a href="/auth/logout/" class="btn" style="background: #dc3545; color: white; padding: 8px 20px;">Logout</a>
      </div>
    </div>

    <div id="status" class="status" style="min-height: 1.25rem; margin: 0.75rem 0 0;"></div>

    <div class="card">
      <form id="editForm">
        <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-bottom:1rem;">
          <a class="btn" href="/api/releases/open/view/">Cancel</a>
          <button type="submit" class="btn btn-accent">Save Changes</button>
        </div>

        <div class="grid">
          <div class="form-group">
            <label>Release #</label>
            <input id="releaseNumber" type="text" readonly>
          </div>
          <div class="form-group">
            <label>Release Date</label>
            <input id="releaseDate" type="date">
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="statusSelect">
              <option value="OPEN">Open</option>
              <option value="COMPLETE">Complete</option>
              <option value="CANCELLED">Cancelled</option>
            </select>
          </div>
          <div class="form-group">
            <label>Customer ID</label>
            <input id="customerId" type="text">
          </div>
          <div class="form-group">
            <label>Customer PO</label>
            <input id="customerPO" type="text">
          </div>
          <div class="form-group">
            <label>Carrier</label>
            <input id="carrier" type="text">
          </div>
          <div class="form-group">
            <label>Quantity (Net Tons)</label>
            <input id="qtyTons" type="number" step="0.001">
          </div>
        </div>

        <div class="form-group" style="margin-top: .75rem;">
          <label>Ship To</label>
          <div style="display:grid; grid-template-columns: 1fr 2fr; gap: 0.75rem; margin-bottom: 0.5rem;">
            <input id="shipToName" placeholder="Name" type="text">
            <input id="shipToStreet" placeholder="Street" type="text">
          </div>
          <div style="display:grid; grid-template-columns: 1.5fr 0.5fr 0.5fr; gap: 0.75rem;">
            <input id="shipToCity" placeholder="City" type="text">
            <input id="shipToState" placeholder="State" maxlength="2" type="text">
            <input id="shipToZip" placeholder="Zip (5)" inputmode="numeric" pattern="\d{5}" type="text">
          </div>
        </div>

        <div class="grid" style="margin-top:.75rem;">
          <div class="form-group">
            <label>Lot</label>
            <input id="materialLot" type="text">
          </div>
          <div class="form-group">
            <label>Material Description</label>
            <input id="materialDescription" type="text">
          </div>
        </div>

        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
          <div class="form-group"><label>C</label><input id="chemC" type="number" step="0.001"></div>
          <div class="form-group"><label>Si</label><input id="chemSi" type="number" step="0.001"></div>
          <div class="form-group"><label>S</label><input id="chemS" type="number" step="0.001"></div>
          <div class="form-group"><label>P</label><input id="chemP" type="number" step="0.001"></div>
          <div class="form-group"><label>Mn</label><input id="chemMn" type="number" step="0.001"></div>
        </div>
      </form>

      <!-- Loads/Shipments Section -->
      <div id="loads-section" style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #ddd;">
        <h3>Loads / Shipments</h3>

        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
          <thead>
            <tr style="background-color: #f5f5f5; text-align: left;">
              <th style="padding: 12px;">Load #</th>
              <th style="padding: 12px;">Weight (tons)</th>
              <th style="padding: 12px;">Status</th>
              <th style="padding: 12px;">BOL Number</th>
              <th style="padding: 12px;">Date Shipped</th>
              <th style="padding: 12px;">Action</th>
            </tr>
          </thead>
          <tbody id="loads-table-body">
            <!-- Populated by JavaScript -->
          </tbody>
        </table>

        <div id="loads-summary" style="margin-top: 1rem; padding: 1rem; background-color: #f9f9f9; border-radius: 4px;">
          <!-- Summary populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <script>
    function show(msg, type='success', ms=3000){
      const s=document.getElementById('status'); s.textContent=msg; s.className='status '+type; if(ms>0) setTimeout(()=>{s.className='status';s.textContent='';},ms);
    }
    function toISO(d){ if(!d) return ''; if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d; try{ const dt=new Date(d); if(!isNaN(dt)) return dt.toISOString().slice(0,10);}catch(e){} return ''; }
    function toNum(v){ const s=(v??'').toString().trim(); if(s==='') return undefined; const n=Number(s); return Number.isFinite(n)?n:undefined; }
    function rid(){ const m=window.location.pathname.match(/\/api\/releases\/(\d+)\//); return m? Number(m[1]) : null; }

    function renderLoads(loads, summary) {
      const tbody = document.getElementById('loads-table-body');
      tbody.innerHTML = '';

      if (!loads || loads.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="padding: 1rem; text-align: center; color: #6b7280;">No loads scheduled for this release</td></tr>';
        document.getElementById('loads-summary').innerHTML = '';
        return;
      }

      loads.forEach(load => {
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid #eee';

        // Status badge styling
        let statusBadge = '';
        if (load.status === 'SHIPPED') {
          statusBadge = '<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">SHIPPED</span>';
        } else if (load.status === 'PENDING') {
          statusBadge = '<span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">PENDING</span>';
        } else if (load.status === 'CANCELLED') {
          statusBadge = '<span style="background: #6b7280; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">CANCELLED</span>';
        }

        // BOL number (clickable if exists) - use stamped PDF if available
        let bolCell = '-';
        if (load.bol_number) {
          const bolPdfUrl = load.bol_stamped_pdf_url || load.bol_pdf_url;
          if (bolPdfUrl) {
            bolCell = `<a href="${bolPdfUrl}" target="_blank" style="color: #2563eb; text-decoration: underline;">${load.bol_number}</a>`;
          }
        }

        // Date shipped
        let dateCell = '-';
        if (load.bol_created_at) {
          const date = new Date(load.bol_created_at);
          dateCell = date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        }

        // Action button
        let actionCell = '';
        if (load.status === 'PENDING') {
          actionCell = `<button onclick="createBOLForLoad(${load.id})" style="background: #2563eb; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Create BOL</button>`;
        } else if (load.status === 'SHIPPED') {
          // Use stamped PDF if available (when official weight entered), otherwise original
          const pdfUrl = load.bol_stamped_pdf_url || load.bol_pdf_url;
          if (pdfUrl) {
            actionCell = `<button onclick="window.open('${pdfUrl}', '_blank')" style="background: #059669; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">View BOL</button>`;
          }
        }

        // Determine weight display - official weight prominently, CBRT as estimate
        // Color scheme: ðŸŸ¢ Official = #059669 (green), ðŸŸ  CBRT = #f59e0b (amber)
        let weightCell = '-';
        if (load.official_weight_tons) {
          // Official weight exists - show prominently with CBRT as secondary
          const official = parseFloat(load.official_weight_tons).toFixed(2);
          const cbrt = parseFloat(load.cbrt_tons || 0).toFixed(2);
          const variance = (load.official_weight_tons - (load.cbrt_tons || 0)).toFixed(2);
          const varianceColor = Math.abs(variance) > 0.5 ? '#ef4444' : '#10b981';
          weightCell = `
            <div style="font-weight: 700; font-size: 1.1em; color: #059669;">${official} <span style="font-size: 0.75em; font-weight: 400;">tons</span></div>
            <div style="font-size: 0.85em; color: #f59e0b;">Est: ${cbrt} <span style="color: ${varianceColor}; font-weight: 600;">(${variance >= 0 ? '+' : ''}${variance})</span></div>
          `;
        } else if (load.cbrt_tons) {
          // Only CBRT estimate available
          const cbrt = parseFloat(load.cbrt_tons).toFixed(2);
          weightCell = `
            <div style="font-weight: 700; font-size: 1.1em; color: #f59e0b;">${cbrt} <span style="font-size: 0.75em; font-weight: 400;">tons</span></div>
            <div style="font-size: 0.85em; color: #f59e0b; font-style: italic;">Estimate</div>
          `;
        }

        row.innerHTML = `
          <td style="padding: 12px;">${load.seq}</td>
          <td style="padding: 12px;">${weightCell}</td>
          <td style="padding: 12px;">${statusBadge}</td>
          <td style="padding: 12px;">${bolCell}</td>
          <td style="padding: 12px;">${dateCell}</td>
          <td style="padding: 12px;">${actionCell}</td>
        `;

        tbody.appendChild(row);
      });

      // Render summary
      if (summary) {
        const summaryDiv = document.getElementById('loads-summary');
        const shippedPct = summary.total_loads > 0
          ? Math.round((summary.shipped_loads / summary.total_loads) * 100)
          : 0;

        summaryDiv.innerHTML = `
          <strong>Summary:</strong>
          ${summary.shipped_loads} of ${summary.total_loads} loads shipped (${shippedPct}%) |
          ${parseFloat(summary.shipped_tons).toFixed(2)} / ${parseFloat(summary.total_tons).toFixed(2)} tons |
          ${summary.pending_loads} pending, ${summary.cancelled_loads} cancelled
        `;
      }
    }

    function createBOLForLoad(loadId) {
      // Navigate to office.html with pre-filled load ID
      window.location.href = `/office.html?loadId=${loadId}`;
    }

    async function load(){
      const id = rid(); if(!id){ show('Invalid URL','error',6000); return; }
      const r = await fetch(`/api/releases/${id}/`, { credentials:'same-origin' });
      if(!r.ok){ show('Failed to load release','error',6000); return; }
      const rel = await r.json();
      document.getElementById('releaseNumber').value = rel.release_number || '';
      document.getElementById('releaseDate').value = toISO(rel.release_date) || '';
      document.getElementById('statusSelect').value = rel.status || 'OPEN';
      document.getElementById('customerId').value = rel.customer_id_text || '';
      document.getElementById('customerPO').value = rel.customer_po || '';
      document.getElementById('carrier').value = rel.ship_via || '';
      document.getElementById('qtyTons').value = rel.quantity_net_tons ?? '';
      document.getElementById('shipToName').value = rel.ship_to_name || '';
      document.getElementById('shipToStreet').value = rel.ship_to_street || '';
      document.getElementById('shipToCity').value = rel.ship_to_city || '';
      document.getElementById('shipToState').value = rel.ship_to_state || '';
      document.getElementById('shipToZip').value = rel.ship_to_zip || '';
      document.getElementById('materialLot').value = rel.lot || '';
      document.getElementById('materialDescription').value = rel.material_description || '';
      // Chemistry from lot_ref if present
      const lot = rel.lot_ref || {};
      document.getElementById('chemC').value = lot.c ?? '';
      document.getElementById('chemSi').value = lot.si ?? '';
      document.getElementById('chemS').value = lot.s ?? '';
      document.getElementById('chemP').value = lot.p ?? '';
      document.getElementById('chemMn').value = lot.mn ?? '';

      // Render loads table
      renderLoads(rel.loads || [], rel.loads_summary);
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = rid(); if(!id) return;

      // Check if status is being changed to CANCELLED
      const newStatus = document.getElementById('statusSelect').value;
      if (newStatus === 'CANCELLED') {
        const confirmed = confirm(
          'Are you sure you want to cancel this release?\n\n' +
          'This will:\n' +
          'â€¢ Cancel all pending loads\n' +
          'â€¢ Prevent cancellation if any loads have been shipped\n\n' +
          'This action cannot be undone.'
        );
        if (!confirmed) return;
      }

      const payload = {
        releaseDate: document.getElementById('releaseDate').value || undefined,
        status: newStatus || undefined,
        customerId: document.getElementById('customerId').value || undefined,
        customerPO: document.getElementById('customerPO').value || undefined,
        shipVia: document.getElementById('carrier').value || undefined,
        shipTo: {
          name: document.getElementById('shipToName').value || '',
          street: document.getElementById('shipToStreet').value || '',
          city: document.getElementById('shipToCity').value || '',
          state: document.getElementById('shipToState').value || '',
          zip: (document.getElementById('shipToZip').value || '').replace(/\D/g,'').slice(0,5),
        },
        material: {
          lot: document.getElementById('materialLot').value || '',
          description: document.getElementById('materialDescription').value || '',
          analysis: {
            C: toNum(document.getElementById('chemC').value),
            Si: toNum(document.getElementById('chemSi').value),
            S: toNum(document.getElementById('chemS').value),
            P: toNum(document.getElementById('chemP').value),
            Mn: toNum(document.getElementById('chemMn').value),
          }
        },
        quantityNetTons: toNum(document.getElementById('qtyTons').value),
      };
      const csrf = (window.Utils && Utils.getCSRFToken) ? Utils.getCSRFToken() : null;
      const r = await fetch(`/api/releases/${id}/`, {
        method: 'PATCH',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json', ...(csrf ? {'X-CSRFToken': csrf} : {}) },
        body: JSON.stringify(payload)
      });
      const j = await r.json().catch(()=>null);
      if (!r.ok){ show((j&&j.error)||`HTTP ${r.status}`,'error',8000); return; }
      show('Release updated','success');
      setTimeout(()=>{ window.location.href='/api/releases/open/view/'; }, 800);
    });

    load().catch(()=>show('Failed to load release','error',6000));
  </script>
</body>
</html>
