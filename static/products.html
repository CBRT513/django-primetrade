<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products | PrimeTrade</title>
    <style>
        :root {
            --brand-primary: #005500;
            --brand-dark: #004400;
            --brand-light: #e8f5e9;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --text-muted: #999;
            --bg-white: #fff;
            --bg-light: #f9fafb;
            --border-color: #e5e5e5;
            --success: #28a745;
            --warning: #f59e0b;
            --danger: #dc2626;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--bg-light); color: var(--text-primary); line-height: 1.5; min-height: 100vh; }

        .header { background: var(--bg-white); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; }
        .header-inner { max-width: 1400px; margin: 0 auto; padding: 0 24px; display: flex; align-items: center; justify-content: space-between; height: 64px; }
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; }
        .logo-img { height: 36px; width: auto; }
        .brand-pipe { color: #2563EB; font-size: 1.75rem; font-weight: 300; margin: 0 16px; }
        .brand-logo { height: 32px; width: auto; }
        .logo-sub { font-size: 11px; color: var(--text-secondary); font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase; }
        .user-menu { display: flex; align-items: center; gap: 16px; }
        .user-name { font-size: 14px; color: var(--text-secondary); }
        .btn-logout { padding: 8px 16px; background: var(--bg-light); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px; text-decoration: none; transition: all 0.2s; }
        .btn-logout:hover { background: var(--bg-white); border-color: var(--brand-primary); color: var(--brand-primary); }

        .nav { background: var(--bg-white); border-bottom: 1px solid var(--border-color); }
        .nav-inner { max-width: 1400px; margin: 0 auto; padding: 0 24px; display: flex; gap: 4px; }
        .nav-link { display: flex; align-items: center; gap: 8px; padding: 14px 20px; color: var(--text-secondary); text-decoration: none; font-size: 14px; font-weight: 500; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .nav-link:hover { color: var(--brand-primary); background: var(--brand-light); }
        .nav-link.active { color: var(--brand-primary); border-bottom-color: var(--brand-primary); }
        .nav-icon { width: 18px; height: 18px; opacity: 0.7; }

        .main { max-width: 1400px; margin: 0 auto; padding: 32px 24px; }
        .page-header { margin-bottom: 24px; }
        .page-title { font-size: 28px; font-weight: 700; color: var(--text-primary); }
        .page-subtitle { font-size: 15px; color: var(--text-secondary); }

        .content { display: grid; grid-template-columns: 380px 1fr; gap: 24px; }
        @media (max-width: 1024px) { .content { grid-template-columns: 1fr; } }

        .card { background: var(--bg-white); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }
        .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-primary); }
        .card-body { padding: 20px; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
        .form-group input[type="text"], .form-group input[type="number"] { width: 100%; padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; transition: all 0.2s; }
        .form-group input:focus { outline: none; border-color: var(--brand-primary); box-shadow: 0 0 0 3px rgba(0, 85, 0, 0.1); }
        .checkbox-group { display: flex; align-items: center; gap: 8px; margin: 16px 0; }
        .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--brand-primary); }
        .checkbox-group label { font-size: 14px; color: var(--text-primary); cursor: pointer; }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 18px; border-radius: 6px; font-size: 14px; font-weight: 500; text-decoration: none; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--brand-primary); color: white; }
        .btn-primary:hover { background: var(--brand-dark); }
        .btn-secondary { background: var(--bg-light); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { border-color: var(--brand-primary); color: var(--brand-primary); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .button-group { display: flex; gap: 8px; margin-top: 16px; }

        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); background: var(--bg-light); }
        td { font-size: 14px; }
        tr:last-child td { border-bottom: none; }
        tbody tr:hover { background: var(--bg-light); }
        tr.inactive { opacity: 0.6; background: #fafafa; }

        .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge-active { background: #dcfce7; color: #166534; }
        .badge-inactive { background: #fee2e2; color: #991b1b; }

        .tons-display { font-weight: 600; color: var(--brand-primary); }
        .chem { font-size: 12px; color: var(--text-secondary); font-family: monospace; }
        .actions { display: flex; gap: 6px; justify-content: flex-end; }

        .status { padding: 12px 16px; margin-bottom: 16px; border-radius: 8px; font-size: 14px; display: none; }
        .status.success { background: #dcfce7; color: #166534; display: block; }
        .status.error { background: #fee2e2; color: #991b1b; display: block; }

        .empty-state { text-align: center; padding: 48px 24px; color: var(--text-muted); }
        a { color: var(--brand-primary); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 999; display: none; }
        .overlay.show { display: block; }
        .confirm-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); z-index: 1000; display: none; min-width: 400px; }
        .confirm-dialog.show { display: block; }
        .confirm-dialog h3 { margin-bottom: 12px; }
        .confirm-dialog p { color: var(--text-secondary); margin-bottom: 16px; }

        .footer { text-align: center; padding: 24px; color: var(--text-muted); font-size: 13px; border-top: 1px solid var(--border-color); background: var(--bg-white); margin-top: 32px; }
    </style>
</head>
<body>
    <script src="/static/js/staging-banner.js"></script>
    <header class="header">
        <div class="header-inner">
            <a href="/" class="logo">
                <img src="/static/cbrt-logo.jpg" alt="CBRT" class="logo-img">
                <span class="brand-pipe">|</span>
                <img src="/static/images/primetrade_logo.png" alt="PrimeTrade" class="brand-logo">
            </a>
            <div style="flex-grow: 1; text-align: center;"><span class="logo-sub">Staff Portal</span></div>
            <div class="user-menu">
                <span class="user-name" id="usernameDisplay">Loading...</span>
                <a href="/auth/logout/" class="btn-logout">Sign Out</a>
            </div>
        </div>
    </header>

    <nav class="nav">
        <div class="nav-inner">
            <a href="/" class="nav-link"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>Dashboard</a>
            <a href="/open-releases/" class="nav-link"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>Releases</a>
            <a href="/loading-schedule.html" class="nav-link"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5"/></svg>Schedule</a>
            <a href="/products.html" class="nav-link active"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>Products</a>
            <a href="/customers.html" class="nav-link"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>Customers</a>
            <a href="/carriers.html" class="nav-link"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>Carriers</a>
            <a href="/admin/" class="nav-link" target="_blank"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Admin</a>
        </div>
    </nav>

    <main class="main">
        <div class="page-header">
            <h1 class="page-title">Products</h1>
            <p class="page-subtitle">Manage product catalog and inventory</p>
        </div>

        <div id="status" class="status"></div>

        <div class="content">
            <div class="card">
                <div class="card-header"><h2 class="card-title" id="formTitle">Add Product</h2></div>
                <div class="card-body">
                    <form id="productForm">
                        <input type="hidden" id="editId" />
                        <div class="form-group">
                            <label>Product Name *</label>
                            <input type="text" id="name" placeholder="e.g., Nodular Pig Iron" required />
                        </div>
                        <div class="form-group">
                            <label>Starting Tons *</label>
                            <input type="number" id="startTons" step="0.01" min="0" placeholder="e.g., 1000.00" required />
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="isActive" checked />
                            <label for="isActive">Active (Available for BOLs)</label>
                        </div>
                        <div class="button-group">
                            <button type="submit" class="btn btn-primary" id="submitBtn">Add Product</button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2 class="card-title">All Products</h2></div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Product</th>
                                <th style="text-align: right;">Starting</th>
                                <th style="text-align: right;">Shipped</th>
                                <th style="text-align: right;">Remaining</th>
                                <th style="text-align: right;">Committed</th>
                                <th style="text-align: right;">Available</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productList">
                            <tr><td colspan="8" class="empty-state">Loading products...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">Cincinnati Barge &amp; Rail Terminal &copy; 2025 | <a href="https://barge2rail.com">barge2rail.com</a></footer>

    <div class="overlay" id="overlay" onclick="closeDeleteDialog()"></div>
    <div class="confirm-dialog" id="deleteDialog">
        <h3>Confirm Delete</h3>
        <p>Are you sure you want to delete this product?</p>
        <p id="deleteMessage"></p>
        <div class="button-group">
            <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            <button class="btn btn-secondary" onclick="closeDeleteDialog()">Cancel</button>
        </div>
    </div>

    <script src="/static/js/utils.js?v=2"></script>
    <script>
        async function getJSON(url) { const r = await fetch(url, { credentials: 'same-origin' }); if (!r.ok) throw new Error(await r.text()); return r.json(); }
        async function postJSON(url, body) { const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': Utils.getCSRFToken() }, credentials: 'same-origin', body: JSON.stringify(body) }); if (!r.ok) throw new Error(await r.text()); return r.json(); }
        function showStatus(msg, type) { const el = document.getElementById('status'); el.textContent = msg; el.className = 'status ' + type; setTimeout(() => { el.className = 'status'; }, 3000); }

        let products = [], balances = {}, deleteProductId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            try { const user = await getJSON("/api/auth/me/"); document.getElementById("usernameDisplay").textContent = user?.username ? `Welcome, ${user.username}` : "Welcome"; } catch (e) { document.getElementById("usernameDisplay").textContent = "Welcome"; }
            loadProducts();
        });

        async function loadProducts() {
            try {
                const [productsData, balancesData] = await Promise.all([getJSON('/api/products/'), getJSON('/api/balances/')]);
                products = productsData;
                balances = {};
                if (Array.isArray(balancesData)) balancesData.forEach(b => { balances[b.id] = b; });
                renderProducts();
            } catch (error) { console.error('Error loading products:', error); showStatus('Error loading products: ' + error.message, 'error'); }
        }

        function renderProducts() {
            const tbody = document.getElementById('productList');
            if (products.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No products found. Add your first product.</td></tr>'; return; }
            tbody.innerHTML = products.map(product => {
                const isActive = product.is_active !== false;
                const balance = balances[product.id] || { startTons: 0, shipped: 0, committed: 0, remaining: 0, available: 0 };
                const committed = balance.committed || 0;
                const available = balance.available !== undefined ? balance.available : (balance.remaining - committed);
                const committedStyle = committed > 0 ? 'color: #d97706; font-weight: 600;' : '';
                const availableStyle = available > 0 ? 'color: #059669; font-weight: 600;' : (available < 0 ? 'color: #dc2626; font-weight: 600;' : '');
                return `<tr class="${isActive ? '' : 'inactive'}">
                    <td><span class="badge badge-${isActive ? 'active' : 'inactive'}">${isActive ? 'Active' : 'Inactive'}</span></td>
                    <td><strong>${product.name}</strong></td>
                    <td style="text-align: right;">${balance.startTons.toFixed(2)}</td>
                    <td style="text-align: right;">${balance.shipped.toFixed(2)}</td>
                    <td style="text-align: right;">${balance.remaining.toFixed(2)}</td>
                    <td style="text-align: right; ${committedStyle}">${committed.toFixed(2)}</td>
                    <td style="text-align: right; ${availableStyle}">${available.toFixed(2)}</td>
                    <td class="actions">
                        <button class="btn btn-primary btn-sm" onclick="editProduct(${product.id})">Edit</button>
                        <button class="btn ${isActive ? 'btn-warning' : 'btn-secondary'} btn-sm" onclick="toggleStatus(${product.id}, ${isActive})">${isActive ? 'Deactivate' : 'Activate'}</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            document.getElementById('editId').value = id;
            document.getElementById('name').value = product.name;
            document.getElementById('startTons').value = product.start_tons;
            document.getElementById('isActive').checked = product.is_active !== false;
            document.getElementById('formTitle').textContent = 'Edit Product';
            document.getElementById('submitBtn').textContent = 'Update Product';
            document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });
        }

        async function toggleStatus(id, currentStatus) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            try {
                await postJSON('/api/products/', { id: product.id, name: product.name, start_tons: product.start_tons, is_active: !currentStatus });
                showStatus(`Product ${!currentStatus ? 'activated' : 'deactivated'} successfully`, 'success');
                await loadProducts();
            } catch (error) { showStatus('Error updating product status: ' + error.message, 'error'); }
        }

        function resetForm() {
            document.getElementById('productForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('formTitle').textContent = 'Add Product';
            document.getElementById('submitBtn').textContent = 'Add Product';
            document.getElementById('isActive').checked = true;
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            const productData = { name: document.getElementById('name').value.trim(), start_tons: parseFloat(document.getElementById('startTons').value), is_active: document.getElementById('isActive').checked };
            if (editId) productData.id = editId;
            try {
                await postJSON('/api/products/', productData);
                showStatus(editId ? 'Product updated successfully' : 'Product added successfully', 'success');
                resetForm();
                await loadProducts();
            } catch (error) { showStatus('Error saving product: ' + error.message, 'error'); }
        });
    </script>
</body>
</html>
