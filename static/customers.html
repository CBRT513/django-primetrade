<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customers | PrimeTrade</title>
    <style>
        :root { --brand-primary: #005500; --brand-dark: #004400; --brand-light: #e8f5e9; --text-primary: #1a1a1a; --text-secondary: #666; --text-muted: #999; --bg-white: #fff; --bg-light: #f9fafb; --border-color: #e5e5e5; --success: #28a745; --warning: #f59e0b; --danger: #dc2626; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--bg-light); color: var(--text-primary); line-height: 1.5; min-height: 100vh; }

        .header { background: var(--bg-white); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; }
        .header-inner { max-width: 1400px; margin: 0 auto; padding: 0 24px; display: flex; align-items: center; justify-content: space-between; height: 64px; }
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; }
        .logo-img { height: 36px; width: auto; }
        .brand-pipe { color: #2563EB; font-size: 1.75rem; font-weight: 300; margin: 0 16px; }
        .brand-logo { height: 32px; width: auto; }
        .logo-sub { font-size: 11px; color: var(--text-secondary); font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase; }
        .user-menu { display: flex; align-items: center; gap: 16px; }
        .user-name { font-size: 14px; color: var(--text-secondary); }
        .btn-logout { padding: 8px 16px; background: var(--bg-light); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px; text-decoration: none; transition: all 0.2s; }
        .btn-logout:hover { background: var(--bg-white); border-color: var(--brand-primary); color: var(--brand-primary); }

        .nav { background: var(--bg-white); border-bottom: 1px solid var(--border-color); }
        .nav-inner { max-width: 1400px; margin: 0 auto; padding: 0 24px; display: flex; gap: 4px; }
        .nav-link { display: flex; align-items: center; gap: 8px; padding: 14px 20px; color: var(--text-secondary); text-decoration: none; font-size: 14px; font-weight: 500; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .nav-link:hover { color: var(--brand-primary); background: var(--brand-light); }
        .nav-link.active { color: var(--brand-primary); border-bottom-color: var(--brand-primary); }
        .nav-icon { width: 18px; height: 18px; opacity: 0.7; }

        .main { max-width: 1400px; margin: 0 auto; padding: 32px 24px; }
        .page-header { margin-bottom: 24px; }
        .page-title { font-size: 28px; font-weight: 700; color: var(--text-primary); }
        .page-subtitle { font-size: 15px; color: var(--text-secondary); }

        .content { display: grid; grid-template-columns: 380px 1fr; gap: 24px; }
        @media (max-width: 1024px) { .content { grid-template-columns: 1fr; } }

        .card { background: var(--bg-white); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; }
        .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-primary); }
        .card-body { padding: 20px; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
        .form-group input { width: 100%; padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; transition: all 0.2s; }
        .form-group input:focus { outline: none; border-color: var(--brand-primary); box-shadow: 0 0 0 3px rgba(0, 85, 0, 0.1); }
        .form-row { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; margin: 16px 0; }
        .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--brand-primary); }
        .checkbox-group label { font-size: 14px; color: var(--text-primary); cursor: pointer; }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 18px; border-radius: 6px; font-size: 14px; font-weight: 500; text-decoration: none; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--brand-primary); color: white; }
        .btn-primary:hover { background: var(--brand-dark); }
        .btn-secondary { background: var(--bg-light); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { border-color: var(--brand-primary); color: var(--brand-primary); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .button-group { display: flex; gap: 8px; margin-top: 16px; }

        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); background: var(--bg-light); }
        td { font-size: 14px; }
        tr:last-child td { border-bottom: none; }
        tbody tr:hover { background: var(--bg-light); }
        tr.inactive { opacity: 0.6; background: #fafafa; }

        .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge-active, .badge.active { background: #dcfce7; color: #166534; }
        .badge-inactive, .badge.inactive { background: #fee2e2; color: #991b1b; }

        .address-display { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
        .actions { display: flex; gap: 6px; justify-content: flex-end; flex-wrap: wrap; }

        .status { padding: 12px 16px; margin-bottom: 16px; border-radius: 8px; font-size: 14px; display: none; }
        .status.success { background: #dcfce7; color: #166534; display: block; }
        .status.error { background: #fee2e2; color: #991b1b; display: block; }
        .empty-state { text-align: center; padding: 48px 24px; color: var(--text-muted); }
        a { color: var(--brand-primary); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 1000; }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-white); border-radius: 12px; width: min(900px, 95vw); max-height: 90vh; overflow: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border-color); }
        .modal-body { padding: 20px; }

        .footer { text-align: center; padding: 24px; color: var(--text-muted); font-size: 13px; border-top: 1px solid var(--border-color); background: var(--bg-white); margin-top: 32px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-inner">
            <a href="/" class="logo">
                <img src="/static/cbrt-logo.jpg" alt="CBRT" class="logo-img">
                <span class="brand-pipe">|</span>
                <img src="/static/images/primetrade_logo.png" alt="PrimeTrade" class="brand-logo">
            </a>
            <div style="flex-grow: 1; text-align: center;"><span class="logo-sub">Staff Portal</span></div>
            <div class="user-menu">
                <span class="user-name" id="usernameDisplay">Loading...</span>
                <a href="/auth/logout/" class="btn-logout">Sign Out</a>
            </div>
        </div>
    </header>

    <nav class="nav">
        <div class="nav-inner">
            <a href="/" class="nav-link"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>Dashboard</a>
            <a href="/open-releases/" class="nav-link"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>Releases</a>
            <a href="/loading-schedule.html" class="nav-link"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5"/></svg>Schedule</a>
            <a href="/products.html" class="nav-link"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>Products</a>
            <a href="/customers.html" class="nav-link active"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>Customers</a>
            <a href="/carriers.html" class="nav-link"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>Carriers</a>
            <a href="/admin/" class="nav-link" target="_blank"><svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Admin</a>
        </div>
    </nav>

    <main class="main">
        <div class="page-header">
            <h1 class="page-title">Customers</h1>
            <p class="page-subtitle">Manage customer database and ship-to addresses</p>
        </div>

        <div id="status" class="status"></div>

        <div class="content">
            <div class="card">
                <div class="card-header"><h2 class="card-title" id="formTitle">Add Customer</h2></div>
                <div class="card-body">
                    <form id="customerForm">
                        <input type="hidden" id="editId" />
                        <div class="form-group"><label>Customer Name *</label><input type="text" id="customer" placeholder="e.g., ABC Steel Corp" required /></div>
                        <div class="form-group"><label>Street Address *</label><input type="text" id="address" placeholder="e.g., 123 Main Street" required /></div>
                        <div class="form-group"><label>Address Line 2</label><input type="text" id="address2" placeholder="e.g., Suite 100" /></div>
                        <div class="form-row">
                            <div class="form-group"><label>City *</label><input type="text" id="city" placeholder="e.g., Cincinnati" required /></div>
                            <div class="form-group"><label>State *</label><input type="text" id="state" placeholder="OH" maxlength="2" required /></div>
                        </div>
                        <div class="form-group"><label>ZIP Code *</label><input type="text" id="zip" placeholder="45202" pattern="[0-9]{5}(-[0-9]{4})?" required /></div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="isActive" checked />
                            <label for="isActive">Active (Available for BOLs)</label>
                        </div>
                        <div class="button-group">
                            <button type="submit" class="btn btn-primary" id="submitBtn">Add Customer</button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2 class="card-title">All Customers</h2></div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>Status</th><th>Customer</th><th>Headquarters Address</th><th style="text-align: right;">Actions</th></tr></thead>
                        <tbody id="customerList"><tr><td colspan="4" class="empty-state">Loading customers...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">Cincinnati Barge &amp; Rail Terminal &copy; 2025 | <a href="https://barge2rail.com">barge2rail.com</a></footer>

    <!-- Ship-To Modal -->
    <div id="shipToModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="shipToTitle" class="card-title">Manage Ship-To Addresses</h3>
                <button id="closeShipTo" class="btn btn-secondary btn-sm">Close</button>
            </div>
            <div class="modal-body">
                <div class="table-wrapper" style="margin-bottom: 20px;">
                    <table>
                        <thead><tr><th>Name</th><th>Street</th><th>City</th><th>State</th><th>Zip</th><th>Status</th><th style="text-align:right;">Actions</th></tr></thead>
                        <tbody id="shipToList"></tbody>
                    </table>
                </div>
                <div class="card">
                    <div class="card-header"><h4 class="card-title">Add/Edit Ship-To</h4></div>
                    <div class="card-body">
                        <form id="shipToForm">
                            <input type="hidden" id="shipToId" />
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                                <div class="form-group"><label>Name</label><input id="stName" type="text" placeholder="Location name"></div>
                                <div class="form-group"><label>Street *</label><input id="stStreet" type="text" required></div>
                                <div class="form-group"><label>City *</label><input id="stCity" type="text" required></div>
                                <div class="form-group"><label>State *</label><input id="stState" type="text" maxlength="2" required></div>
                                <div class="form-group"><label>Zip *</label><input id="stZip" type="text" pattern="\d{5}" required></div>
                            </div>
                            <div class="button-group" style="justify-content: flex-end;">
                                <button type="button" class="btn btn-secondary" id="shipToCancel">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Ship-To</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/utils.js?v=2"></script>
    <script>
        async function getJSON(url) { const r = await fetch(url, { credentials: 'same-origin' }); if (!r.ok) throw new Error(await r.text()); return r.json(); }
        async function postJSON(url, body) { const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': Utils.getCSRFToken() }, credentials: 'same-origin', body: JSON.stringify(body) }); if (!r.ok) throw new Error(await r.text()); return r.json(); }
        function showStatus(msg, type) { const el = document.getElementById('status'); el.textContent = msg; el.className = 'status ' + type; setTimeout(() => { el.className = 'status'; }, 3000); }

        let customers = [];
        document.addEventListener('DOMContentLoaded', async () => {
            try { const user = await getJSON("/api/auth/me/"); document.getElementById("usernameDisplay").textContent = user?.username ? `Welcome, ${user.username}` : "Welcome"; } catch (e) { document.getElementById("usernameDisplay").textContent = "Welcome"; }
            loadCustomers();
            document.getElementById('state').addEventListener('input', (e) => { e.target.value = e.target.value.toUpperCase(); });
        });

        async function loadCustomers() {
            try { customers = await getJSON('/api/customers/'); renderCustomers(); }
            catch (error) { console.error('Error loading customers:', error); showStatus('Error loading customers: ' + error.message, 'error'); }
        }

        let shipToCustomerId = null, shipTos = [];

        function renderCustomers() {
            const tbody = document.getElementById('customerList');
            if (customers.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No customers found. Add your first customer.</td></tr>'; return; }
            tbody.innerHTML = customers.map(c => {
                const isActive = c.is_active !== false;
                const addr = [c.address, c.address2, `${c.city}, ${c.state} ${c.zip}`].filter(Boolean).join('<br>');
                return `<tr class="${isActive ? '' : 'inactive'}">
                    <td><span class="badge badge-${isActive ? 'active' : 'inactive'}">${isActive ? 'Active' : 'Inactive'}</span></td>
                    <td><strong>${c.customer}</strong></td>
                    <td class="address-display">${addr}</td>
                    <td class="actions">
                        <button class="btn btn-primary btn-sm" onclick="editCustomer(${c.id})">Edit</button>
                        <button class="btn btn-secondary btn-sm" onclick="openShipTo(${c.id}, '${c.customer.replace(/'/g,"&#39;")}')">Ship-Tos</button>
                        <button class="btn ${isActive ? 'btn-warning' : 'btn-secondary'} btn-sm" onclick="toggleStatus(${c.id}, ${isActive})">${isActive ? 'Deactivate' : 'Activate'}</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function editCustomer(id) {
            const c = customers.find(x => x.id === id); if (!c) return;
            document.getElementById('editId').value = id;
            document.getElementById('customer').value = c.customer;
            document.getElementById('address').value = c.address;
            document.getElementById('address2').value = c.address2 || '';
            document.getElementById('city').value = c.city;
            document.getElementById('state').value = c.state;
            document.getElementById('zip').value = c.zip;
            document.getElementById('isActive').checked = c.is_active !== false;
            document.getElementById('formTitle').textContent = 'Edit Customer';
            document.getElementById('submitBtn').textContent = 'Update Customer';
            document.getElementById('customerForm').scrollIntoView({ behavior: 'smooth' });
        }

        async function toggleStatus(id, current) {
            const c = customers.find(x => x.id === id); if (!c) return;
            try {
                await postJSON('/api/customers/', { id: c.id, customer: c.customer, address: c.address, address2: c.address2 || '', city: c.city, state: c.state, zip: c.zip, is_active: !current });
                showStatus(`Customer ${!current ? 'activated' : 'deactivated'} successfully`, 'success');
                await loadCustomers();
            } catch (error) { showStatus('Error updating customer status: ' + error.message, 'error'); }
        }

        function resetForm() {
            document.getElementById('customerForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('formTitle').textContent = 'Add Customer';
            document.getElementById('submitBtn').textContent = 'Add Customer';
            document.getElementById('isActive').checked = true;
        }

        document.getElementById('customerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editId').value;
            const data = { customer: document.getElementById('customer').value.trim(), address: document.getElementById('address').value.trim(), address2: document.getElementById('address2').value.trim(), city: document.getElementById('city').value.trim(), state: document.getElementById('state').value.trim().toUpperCase(), zip: document.getElementById('zip').value.trim(), is_active: document.getElementById('isActive').checked };
            if (editId) data.id = editId;
            try { await postJSON('/api/customers/', data); showStatus(editId ? 'Customer updated' : 'Customer added', 'success'); resetForm(); await loadCustomers(); }
            catch (error) { showStatus('Error saving customer: ' + error.message, 'error'); }
        });

        // Ship-To modal
        const shipToModal = document.getElementById('shipToModal');
        document.getElementById('closeShipTo').addEventListener('click', () => shipToModal.classList.remove('show'));
        document.getElementById('shipToCancel').addEventListener('click', () => { resetShipToForm(); });
        function resetShipToForm() { document.getElementById('shipToForm').reset(); document.getElementById('shipToId').value = ''; }

        async function openShipTo(cid, cname) {
            shipToCustomerId = cid;
            document.getElementById('shipToTitle').textContent = `Ship-To Addresses: ${cname}`;
            await loadShipTos();
            shipToModal.classList.add('show');
        }

        async function loadShipTos() {
            const r = await fetch(`/api/customers/${shipToCustomerId}/shiptos/`, { credentials: 'same-origin' });
            if (!r.ok) { alert(await r.text()); return; }
            shipTos = await r.json();
            renderShipTos();
        }

        function renderShipTos() {
            const tbody = document.getElementById('shipToList');
            if (!shipTos || shipTos.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No ship-to addresses yet.</td></tr>'; return; }
            tbody.innerHTML = shipTos.map(st => {
                const active = st.is_active !== false;
                return `<tr>
                    <td>${st.name||'-'}</td><td>${st.street}</td><td>${st.city}</td><td>${st.state}</td><td>${st.zip}</td>
                    <td><span class="badge badge-${active?'active':'inactive'}">${active?'Active':'Inactive'}</span></td>
                    <td class="actions">
                        <button class="btn btn-primary btn-sm" onclick="editShipTo(${st.id})">Edit</button>
                        <button class="btn ${active?'btn-warning':'btn-secondary'} btn-sm" onclick="toggleShipTo(${st.id}, ${active})">${active?'Deactivate':'Activate'}</button>
                    </td>
                </tr>`;
            }).join('');
        }

        window.editShipTo = function(id) {
            const st = shipTos.find(x=>x.id===id); if(!st) return;
            document.getElementById('shipToId').value = id;
            document.getElementById('stName').value = st.name||'';
            document.getElementById('stStreet').value = st.street||'';
            document.getElementById('stCity').value = st.city||'';
            document.getElementById('stState').value = st.state||'';
            document.getElementById('stZip').value = st.zip||'';
        }

        window.toggleShipTo = async function(id, current) {
            const st = shipTos.find(x=>x.id===id); if(!st) return;
            const payload = { id, name: st.name||'', street: st.street, city: st.city, state: st.state, zip: st.zip, is_active: !current };
            const r = await fetch(`/api/customers/${shipToCustomerId}/shiptos/`, { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json', 'X-CSRFToken': Utils.getCSRFToken()}, body: JSON.stringify(payload) });
            if (!r.ok){ alert(await r.text()); return; }
            await loadShipTos();
        }

        document.getElementById('shipToForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = { id: document.getElementById('shipToId').value || undefined, name: document.getElementById('stName').value || '', street: document.getElementById('stStreet').value || '', city: document.getElementById('stCity').value || '', state: (document.getElementById('stState').value || '').toUpperCase(), zip: (document.getElementById('stZip').value || '').replace(/\D/g,'').slice(0,5), is_active: true };
            const r = await fetch(`/api/customers/${shipToCustomerId}/shiptos/`, { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json', 'X-CSRFToken': Utils.getCSRFToken()}, body: JSON.stringify(payload) });
            if (!r.ok){ alert(await r.text()); return; }
            resetShipToForm();
            await loadShipTos();
        });
    </script>
</body>
</html>
